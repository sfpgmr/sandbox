<!DOCTYPE html>

<html lang="ja" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-15457703-9"></script>
  <script>
    if (!location.hostname.match(/localhost/)) {
      window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      gtag('js', new Date());
      gtag('config', 'UA-15457703-9');
    }
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Twitter Viewer</title>
  <meta name="description" content="自作Twitter Viewerによる自分のつぶやきの記録。Programming,Music,HTML5,WebGL,javascript,WebAudio,Gameなど" />
  <meta name="keywords" content="Programming,Music,HTML5,WebGL,javascript,WebAudio" /> 	

  <meta itemprop="image" content="https://www.sfpgmr.net/img/sfweb.png" />
  <meta itemprop="name" content="S.F. Web" />
  
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="S.F. Web" />
  <meta name="twitter:url" content="./index26.html" />
  <meta name="twitter:title" content="Twitter Viewer" />
  <meta name="twitter:description" content="自作Twitter Viewerによる自分のつぶやきの記録。Programming,Music,HTML5,WebGL,javascript,WebAudio,Gameなど" />
  <meta name="twitter:image" content="https://www.sfpgmr.net/img/sfweb.png" />
  
  <meta property="og:type" content="article">
  <meta property="og:url" content="./index26.html" />
  <meta property="og:title" content="Twitter Viewer"/>
  <meta property="og:site_name" content="S.F. Web" />
  <meta property="og:description" content="Programming,Music,HTML5,WebGL,javascript,WebAudio">
  <meta property="og:image" content="https://www.sfpgmr.net/img/sfweb.png">

  <style>
  * {
  margin: 0;
  padding: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

html {
  margin: 0;
  padding: 0;
  font-size: 10px; }

body {
  margin: 0;
  padding-left: 8px;
  padding-right: 8px;
  background: black;
  color: white; }

.top-nav {
  position: fixed;
  z-index: 99999;
  background: rgba(0, 0, 0, 0.5);
  display: block;
  width: 100%;
  height: 32px;
  color: white; }

#sentinel {
  width: 0px;
  height: 0px; }

.contents {
  padding-top: 32px;
  width: 100%;
  position: relative;
  content: strict; }

@keyframes blinking {
  0% {
    color: black; }
  50% {
    color: white; }
  100% {
    color: black; } }

.loading {
  font-family: monospace;
  font-size: 24px;
  position: fixed;
  width: 100vw;
  height: 100vh;
  text-align: center;
  padding-top: 50vh;
  z-index: 32768;
  background: black;
  animation: blinking 2s infinite;
  content: strict; }

.contents > article {
  background: #f0f0f0;
  color: #202020;
  position: absolute;
  max-height: 960px;
  overflow: auto;
  border-radius: 3px;
  /* transition: opacity 1s linear;*/
  opacity: 1.0; }

.tweet-header {
  display: grid;
  align-items: end;
  grid-template-columns: 40px 2fr 1fr;
  grid-template-rows: 1fr;
  font-size: 12px;
  font-weight: bold; }

.tweet-img {
  width: 100%;
  object-fit: cover; }

.youtube {
  position: relative;
  cursor: pointer; }

.youtube > img {
  width: 100%;
  object-fit: cover; }

.youtube > svg.player-play {
  width: 64px;
  height: 64px;
  left: calc(50% - 32px);
  top: calc(50% - 32px);
  position: absolute;
  z-index: 1000;
  opacity: 0.5; }

.youtube:hover > svg.player-play {
  opacity: 1.0; }

.youtube:hover .player-play-1 {
  stroke: #80808080; }

.youtube > div.yt-title {
  /*text-shadow: #fff 1px 1px 0;*/
  font-size: 1.2rem;
  color: white;
  background: rgba(0, 0, 0, 0.5);
  position: absolute;
  left: 0;
  top: 0;
  overflow: auto;
  z-index: 998; }

.tweet-profile-img {
  grid-column: 1/2;
  width: 32px;
  height: 32px;
  border-radius: 50%; }

.tweet-user-name {
  grid-column: 2/3; }

.tweet-date {
  font-size: 8px;
  text-align: right;
  grid-column: 3/4; }

.contents > twitter-widget {
  overflow: auto;
  max-height: 960px;
  position: absolute; }

.contents > article > section > .tweet-text {
  display: block;
  padding: 4px;
  word-break: break-all;
  font-size: 12px; }

.contents > article > h3 {
  font-size: 12px; }

blockquote.card {
  margin: 4px;
  padding: 4px;
  font-size: 12px;
  background: white;
  border-radius: 4px; }

blockquote.card > header {
  display: grid;
  grid-gap: 4px;
  gap: 4px; }

blockquote.card-default > header {
  grid-template-columns: 64px 1fr; }

blockquote.card-large > header {
  grid-template-columns: 1fr; }

blockquote.card > header > img {
  width: 100%; }

div.no-image {
  display: block;
  width: 64px;
  height: 64px;
  background: gray;
  color: white;
  text-align: center;
  line-height: 64px; }
 
  </style>
</head>

<body>
  <div class="loading" id="loading">Loading</div>
  <header class="top-nav">
    <h1>S.F. Info.</h1>
  </header>
  <div class="contents" id="contents" rendersubtree="invisible skip-activation"> 
    
    
    <article>
      
      
      <header class="tweet-header">
        
        <img class="tweet-profile-img"  src="https://pbs.twimg.com/profile_images/1212701145379946496/pSDVrvWj_normal.png" />
        <p class="tweet-user-name">S.F.@SFPGMR</p>
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1250543592340246528"
            target="_blank">2020/4/16 6:56:41</a></p>
      </header>
      <section>
        <p class="tweet-text">つぶやきGLSLかあ。。<br/><br/><blockquote class="card card-default"><header><img  src="/resource/ogp.png" /><a href="https://twigl.app/" target="_blank">twigl.app</a></header><div>twigl.app is an online editor for One tweet shader, with gif generator and sound shader.</div></blockquote></p>
        
      </section>
      
    </article>
    
    <article>
      
      
      <header class="tweet-header">
        
        <img class="tweet-profile-img"  src="https://pbs.twimg.com/profile_images/1212701145379946496/pSDVrvWj_normal.png" />
        <p class="tweet-user-name">S.F.@SFPGMR</p>
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1250349379430440961"
            target="_blank">2020/4/15 18:04:57</a></p>
      </header>
      <section>
        <p class="tweet-text">スクリッティ・ポリッティが懐かしくて聴いてたんだよね。フェアライトCMIとFM音源を使用した当時としては画期的なアレンジだったらしい。私はそういう目線ではあまり聴いてはなかったけど。<br/><blockquote class="card card-default"><header><img  src="https://i.ytimg.com/vi/teHqHmnXnhE/hqdefault.jpg" /><a href="https://www.youtube.com/watch?v=teHqHmnXnhE" target="_blank">Scritti Politti - Absolute - YouTube</a></header><div>There doesn't seem to be any decent versions of this on You Tube, until now. Enjoy music lovers! I do not own the copyright for this material. Copyright Disc...</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1250350180341149696"
            target="_blank">2020/4/15 18:08:08</a></p>
      </header>
      <section>
        <p class="tweet-text">何が画期的かというとフレーズごとに音色を変えてるとことか。今聴くと普通かもしれないけどね。当時は斬新だったんだよな。フェアライトCMIがあったからこそのこのアレンジですな。FM音源のクリアさと、フェアライトのサンプリングドラムの粗い感じの対比が今聴くと面白い。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1250351055109414921"
            target="_blank">2020/4/15 18:11:36</a></p>
      </header>
      <section>
        <p class="tweet-text">そしてこれが3枚目の「Provision」というアルバムの1曲目。前作の「キューピッド＆サイケ85」よりもサンプリング系の音のクォリティが増している。これはメインのシンセがフェアライト→シンクラビアに変わったからだそう。<br/><blockquote class="card card-default"><header><img  src="https://i.ytimg.com/vi/C7qCaCcfjXg/hqdefault.jpg" /><a href="https://www.youtube.com/watch?v=C7qCaCcfjXg" target="_blank">Scritti Politti Boom! There She Was 80s eighties - YouTube</a></header><div>Scritti Politti - Boom! There She Was</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1250351737103216640"
            target="_blank">2020/4/15 18:14:19</a></p>
      </header>
      <section>
        <p class="tweet-text">ただこの「Provision」、制作にものすごく時間がかかった。それは主に初期のシンクラビアのシーケンサのUIの悪さに起因しているとWikipediaには書かれていた。<br/><br/><blockquote class="card card-default"><header><img  src="https://upload.wikimedia.org/wikipedia/en/b/bf/Provision_%28album%29_cover.jpg" /><a href="https://en.wikipedia.org/wiki/Provision_(album)" target="_blank">Provision (album) - Wikipedia</a></header><div></div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1250352362566254592"
            target="_blank">2020/4/15 18:16:48</a></p>
      </header>
      <section>
        <p class="tweet-text">シンクラビアというのは当時数千万円くらいしたものすごいDAWシステムで、DAWというジャンルを作り出した元祖の一つなんだよな。FMシンセと100KHzのサンプラ、HDDによるテープレス・レコーディングなどまあ時代を先取りしたスペックですわ。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1250354132612829184"
            target="_blank">2020/4/15 18:23:50</a></p>
      </header>
      <section>
        <p class="tweet-text">久保田利伸のアルバムなんかでも使われてたみたい。確かアルバムのインタビューなんかでもシンクラビアの音のクォリティの高さについて久保田さん自身が語っていたのをどこかで読んだことがある。「dance if you want it」の曲あたりだと思うけどね。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1250354729147760640"
            target="_blank">2020/4/15 18:26:12</a></p>
      </header>
      <section>
        <p class="tweet-text">FM音源はエレピの音色が有名だけど、1980年前半あたりではベースでも結構使われてたんだよな。アタックの部分が妙に生っぽくて複雑な感じで、かつ軽い感じの音色といえばわかってもらえるだろうか。これはFM音源だからこそできる音色だと思うんだけど。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1250355554628718598"
            target="_blank">2020/4/15 18:29:29</a></p>
      </header>
      <section>
        <p class="tweet-text">「Perfect Way」のベースもそうだと思うんだよな。違ってたら申し訳ない（笑）。<br/><div class="youtube" data-type="yt" id="s-P94UFne-w"><div class="yt-title">Youtube - Perfect Way</div><svg class="player-play" width="64" height="64" xmlns="http://www.w3.org/2000/svg"><g><path class="player-play-1" fill="#ffffff" stroke-width="1" d="m0,0l64,32l-64,32l0,-64z" /></g></svg><img  data-href="https://youtu.be/s-P94UFne-w" class="youtube" src="https://i.ytimg.com/vi/s-P94UFne-w/hqdefault.jpg" /></div>   <br/></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1250356552403304450"
            target="_blank">2020/4/15 18:33:27</a></p>
      </header>
      <section>
        <p class="tweet-text">もうひとつ例を挙げると細野さんの「S-F-X」の「 Body Snatchers」とかね。アタックがノイズっぽくて（打楽器ぽくて）伸びてる音がクリアな感じ。表現あってる？<br/><br/><div class="youtube" data-type="yt" id="d4gypiuQt5E"><div class="yt-title">Youtube - Haruomi Hosono - S-F-X - 01 - Body Snatchers</div><svg class="player-play" width="64" height="64" xmlns="http://www.w3.org/2000/svg"><g><path class="player-play-1" fill="#ffffff" stroke-width="1" d="m0,0l64,32l-64,32l0,-64z" /></g></svg><img  data-href="https://youtu.be/d4gypiuQt5E" class="youtube" src="https://i.ytimg.com/vi/d4gypiuQt5E/hqdefault.jpg" /></div>   <br/></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1250357572839698433"
            target="_blank">2020/4/15 18:37:30</a></p>
      </header>
      <section>
        <p class="tweet-text">この時代のYAMAHA DXシリーズが果たした役割はほんと大きいよなあ。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1250358340313464832"
            target="_blank">2020/4/15 18:40:33</a></p>
      </header>
      <section>
        <p class="tweet-text">坂本龍一さんの「Ballet Mécanique」もフェライト＋FMの組み合わせだよなあ。エレピの音色が綺麗ですよ。ほんと。そしてこのローファイなフェアライトのリズム。<br/><br/><div class="youtube" data-type="yt" id="_ZaDQL6fobA"><div class="yt-title">Youtube - Ryuichi Sakamoto (坂本龍一) - Ballet Mécanique</div><svg class="player-play" width="64" height="64" xmlns="http://www.w3.org/2000/svg"><g><path class="player-play-1" fill="#ffffff" stroke-width="1" d="m0,0l64,32l-64,32l0,-64z" /></g></svg><img  data-href="https://youtu.be/_ZaDQL6fobA" class="youtube" src="https://i.ytimg.com/vi/_ZaDQL6fobA/hqdefault.jpg" /></div>   <br/></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1250359303690543105"
            target="_blank">2020/4/15 18:44:23</a></p>
      </header>
      <section>
        <p class="tweet-text">この曲もスクリッティ・ポリッティの2枚目と同時代に作成されたものだけど、聴き比べてもらうといかにスクリッティ・ポリッティのアレンジがすごいかわかってもらえると思う。どちらの曲がいいかとかそういう観点ではなくてあくまでアレンジの違いということだけどね。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1250360692332326913"
            target="_blank">2020/4/15 18:49:54</a></p>
      </header>
      <section>
        <p class="tweet-text">私は6オペのシンセは触ったことがない。パソコンいじりが主な趣味だったので4オペのYM2203チップを搭載したFM77-AVが最初になるよな。これをBASICのPlay文使って演奏して楽しんでたという。PSGに比べて段違いな音だよ。違いすぎる（笑）。このチップによるPC音源の進化は衝撃的だったよな。うん。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1250361485433262080"
            target="_blank">2020/4/15 18:53:03</a></p>
      </header>
      <section>
        <p class="tweet-text">ただアルバムの音を聴くと、６オペのFMの音（つつまりDX-7あたりの音）はやっぱり深いというか、複雑な感じはしたよな。かなりの差を感じた。そりゃ楽器とPCだから、もし同じ６オペであったとしても音を出すまでの回路の品質がまるで違うから同じものにはならんとは思う。やっぱり楽器のほうがいい。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1250363089112850435"
            target="_blank">2020/4/15 18:59:25</a></p>
      </header>
      <section>
        <p class="tweet-text">荻野目洋子さんの「フラミンゴ in パラダイス」もフェアライトを使って楽曲が作られていた。リズムがもう「あの音」ですよ。TVでも、もっぱらバッキングに耳を傾けていたあのころ（笑）。<br/><br/><a href="https://youtu.be/36CQUdJ-0-0" target="_blank">youtu.be/36CQUdJ-0-0</a></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1250363564222640129"
            target="_blank">2020/4/15 19:01:18</a></p>
      </header>
      <section>
        <p class="tweet-text">当時のTV番組ってバッキングを生演奏というのがわりと普通だった。「フラミンゴ in パラダイス」だけは「口パク」を期待していたあのころ（笑）。<br/><br/><blockquote class="card card-default"><header><img  src="https://i.ytimg.com/vi/7amTLM1h_1Q/maxresdefault.jpg" /><a href="https://www.youtube.com/watch?v=7amTLM1h_1Q" target="_blank">荻野目洋子 【フラミンゴ in パラダイス】 - YouTube</a></header><div> </div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1250364761046310913"
            target="_blank">2020/4/15 19:06:04</a></p>
      </header>
      <section>
        <p class="tweet-text">この曲はアレンジをフェアライト所有者の船山さんという方が行ったからこそ実現した。歌謡曲では画期的だったんじゃないかなぁと思う。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1250368158117974016"
            target="_blank">2020/4/15 19:19:34</a></p>
      </header>
      <section>
        <p class="tweet-text">ちょっとこれは1990年代になってしまうけど、このBELL BIV DEVOE の「Poison」という曲もリズム・トラックはフェアライトが担っている。<br/><div class="youtube" data-type="yt" id="YejxyaFyUHc"><div class="yt-title">Youtube - BELL BIV DEVOE POISON</div><svg class="player-play" width="64" height="64" xmlns="http://www.w3.org/2000/svg"><g><path class="player-play-1" fill="#ffffff" stroke-width="1" d="m0,0l64,32l-64,32l0,-64z" /></g></svg><img  data-href="https://youtu.be/YejxyaFyUHc" class="youtube" src="https://i.ytimg.com/vi/YejxyaFyUHc/hqdefault.jpg" /></div>   <br/></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1250368688714215424"
            target="_blank">2020/4/15 19:21:40</a></p>
      </header>
      <section>
        <p class="tweet-text">これはたしか初期のフェアライトのサンプリングの粗さを逆手にとったか、もしくはアレンジャーが中古のフェアライトを持っててそのデモ曲はフェアライトで作ってて、メンバーがたいそう気に入ったかなんかそんな感じだったと思う。この粗さをあえて前面にだしたような。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1250369419118661632"
            target="_blank">2020/4/15 19:24:34</a></p>
      </header>
      <section>
        <p class="tweet-text">1990年の頭ころにはもうメジャーな楽曲はシンクラビアとかMacとかで作られるようになってて、ローファイな音が姿を消してたように思う。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1250370274215604224"
            target="_blank">2020/4/15 19:27:58</a></p>
      </header>
      <section>
        <p class="tweet-text">1980年代の前半はサンプリング音源がローファイな音しか出なかった。だけど画期的なアレンジのアルバムはそのあたりの時代にたくさん出た。そのアルバムを聴いた若い世代がその音を気に入ってあえて逆に再現するような動きもあった気がする。1990年代がそうじゃないかなあ</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1250387643247906817"
            target="_blank">2020/4/15 20:36:59</a></p>
      </header>
      <section>
        <p class="tweet-text">この時期ちょっとNew Jack Swingも聴いてた。ちょうどサンプリングの音質が良くなっていった時期と重なる。こういうハネたリズムのポップ・ソングなんかは、もちろんソウル・ミュージックに根ざしたものだけど、シーケンサの進化によるものもおおきいと思うんだよな。<br/><br/><div class="youtube" data-type="yt" id="tLJPsHhcEOo"><div class="yt-title">Youtube - Babyface ft. Toni Braxton - Give U My Heart (Official Video)</div><svg class="player-play" width="64" height="64" xmlns="http://www.w3.org/2000/svg"><g><path class="player-play-1" fill="#ffffff" stroke-width="1" d="m0,0l64,32l-64,32l0,-64z" /></g></svg><img  data-href="https://youtu.be/tLJPsHhcEOo" class="youtube" src="https://i.ytimg.com/vi/tLJPsHhcEOo/hqdefault.jpg" /></div>   <br/></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1250388144505016320"
            target="_blank">2020/4/15 20:38:59</a></p>
      </header>
      <section>
        <p class="tweet-text">ハネたリズムを作るのがとても簡単になったんだよな。このころのシーケンサ。Macの功績がとても大きい。PerformerとかVisionとかそのあたり。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1250389363294232576"
            target="_blank">2020/4/15 20:43:49</a></p>
      </header>
      <section>
        <p class="tweet-text">このSoul Ⅱ Soulなんかの曲も、ハネかたやサンプルのリリースのタイミングとか、そういうのがまあすごく細かい感じがするんだよな。これもやっぱりシーケンサの進化のおかげかなあと思うんだよね。これは1989年の終わりころ。バブルの終焉あたり。<br/><br/><div class="youtube" data-type="yt" id="1iQl46-zIcM"><div class="yt-title">Youtube - Soul II Soul - Keep On Movin' (Official Video)</div><svg class="player-play" width="64" height="64" xmlns="http://www.w3.org/2000/svg"><g><path class="player-play-1" fill="#ffffff" stroke-width="1" d="m0,0l64,32l-64,32l0,-64z" /></g></svg><img  data-href="https://youtu.be/1iQl46-zIcM" class="youtube" src="https://i.ytimg.com/vi/1iQl46-zIcM/hqdefault.jpg" /></div>   <br/></p>
        
      </section>
      
    </article>
    
    <article>
      
      
      <header class="tweet-header">
        
        <img class="tweet-profile-img"  src="https://pbs.twimg.com/profile_images/1212701145379946496/pSDVrvWj_normal.png" />
        <p class="tweet-user-name">S.F.@SFPGMR</p>
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1249801561976352768"
            target="_blank">2020/4/14 5:48:07</a></p>
      </header>
      <section>
        <p class="tweet-text">sqlite3のparse.yを読むためにlemonというパーサー・ジェネレータのドキュメントを読んだり、他のチュートリアルなどを調べていた。<br/><br/><blockquote class="card card-default"><header><div class="no-image" >No Image</div><a href="https://sqlite.org/src/doc/trunk/doc/lemon.html" target="_blank">The Lemon Parser Generator</a></header><div></div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1249802536690704385"
            target="_blank">2020/4/14 5:51:59</a></p>
      </header>
      <section>
        <p class="tweet-text">冒頭に出てきたTerminal SymbolとNon Terminal Symbolて何？という感じである。一応パーサージェネレータはpeg.jsを使ってるのでわかってるつもりだったかわかってなかった。そもそもパーサー・ジェネレータはトークナイザを持っていないのだった。そこでまずハマってた（笑）。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1249803896878325762"
            target="_blank">2020/4/14 5:57:23</a></p>
      </header>
      <section>
        <p class="tweet-text">peg.jsは字句解析をしながらパースしていくタイプだからね。こちらのほうが特殊。sqlite3では字句解析はtokenize.cでやって、そのあとlemonで生成したパーサに渡して構文解析するのであった。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1249805697564307456"
            target="_blank">2020/4/14 6:04:33</a></p>
      </header>
      <section>
        <p class="tweet-text">冒頭のGrammerはこんな感じ<br/><br/>input ::= cmdlist.<br/>cmdlist ::= cmdlist ecmd.<br/>cmdlist ::= ecmd.<br/>ecmd ::= SEMI.<br/>ecmd ::= cmdx SEMI.<br/><br/>Upper CaseなSEMIがTerminal Symbolで、ecmdなどLower CaseなのがNon Terminal Symbol。まあcmdlistがecmdのlistで、ecmdはSEMIで終わるというのはわかる。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1249806644625551360"
            target="_blank">2020/4/14 6:08:19</a></p>
      </header>
      <section>
        <p class="tweet-text">Terminal Symbolというのはそれ自体が独立していて、これ以上分割できないSymbol(token)のこと。Non Terminal Symbolは分割できる。構文は分割されていくと最終的にはTerminal Symbolのリストになるわけですな。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1249807519368630272"
            target="_blank">2020/4/14 6:11:47</a></p>
      </header>
      <section>
        <p class="tweet-text">でlemonは大文字で始まるものはTerminal Symbolと仕様で決めているので、一目でそれがわかる。lemonでは慣習的にTerminal Symbolはすべて大文字で構成し、視覚的によりわかりやすくしているようだ</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1249808517294198785"
            target="_blank">2020/4/14 6:15:45</a></p>
      </header>
      <section>
        <p class="tweet-text">で最初ここ読んだときにSEMIはおそらくセミコロン「;」のことだろうなあと思った。とするとどこかでこれを定義しているコードがあるはずだ。 SEMI = ';' みたいにね。でも「SEMI」で検索してもparse.y内にはどこにもない。それどころかsqlite3のソースコードをすべて検索してもない。なんで？</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1249812580543037440"
            target="_blank">2020/4/14 6:31:54</a></p>
      </header>
      <section>
        <p class="tweet-text">と昨日思っていろいろ調べた。そしてparse.yの冒頭を見るとこんなことが書いてあった。<br/><br/>// All token codes are small integers with #defines that begin with "TK_"<br/>%token_prefix TK_</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1249813281746739200"
            target="_blank">2020/4/14 6:34:41</a></p>
      </header>
      <section>
        <p class="tweet-text">つまりパーサ・コードをlemonが出力するとき、Terminal Symbolの先頭にTK_をつけるというDirectiveが書いてあったから検索しても見つからなかったのだ（笑）。これはいいかえるとparse.y中に記載されるTerminal Symbolはすべて先頭にTK_がついているものと解釈せよということ。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1249814002844098561"
            target="_blank">2020/4/14 6:37:33</a></p>
      </header>
      <section>
        <p class="tweet-text">そしてlemonではシンボルは定義しなくても解析の結果自動的にリストアップして番号をつけて管理しますよとあった。Terminal SymbolはCソース中では#defineで定義される。先ほどのSEMIだと<br/><br/>#define TK_SEMI 1<br/><br/>という感じに定義されるんだな。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1249814470211190784"
            target="_blank">2020/4/14 6:39:24</a></p>
      </header>
      <section>
        <p class="tweet-text">実際のソースコード見ると確かに定義されてる。 https://t.co/B72nK6gLTo</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/EVg7odQUEAESUlG.png" />
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1249815349995769856"
            target="_blank">2020/4/14 6:42:54</a></p>
      </header>
      <section>
        <p class="tweet-text">しかしここで疑問に思ったのがTK_SEMIは1で定義しているが、';'の文字コードは1じゃないよなあということ。これでどうやってセミコロンを判別するのかな？ということ。<br/><br/>ecmd ::= SEMI.<br/><br/>は結局<br/><br/>ecmd := 1.<br/><br/>と等価なのでこれでセミコロンどうやって判別するのかなあと思ったんだな。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1249816788419792896"
            target="_blank">2020/4/14 6:48:37</a></p>
      </header>
      <section>
        <p class="tweet-text">字句解析は文字列を短い文字列に分割する（言語的に意味のある最小単位までに分割）ことだという先入観があったのが災いした。lemon（ふつうはそうなのか？）はそうじゃなかった。字句解析で';'を検出したらTK_SEMIとしてトークン化し、それをlemonに渡すのだった。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1249819504860749824"
            target="_blank">2020/4/14 6:59:25</a></p>
      </header>
      <section>
        <p class="tweet-text">じっさいtokenize.cのコードはこんな感じですな。 https://t.co/lZA6ldAUxW</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/EVg-IxXU4AYIXN9.png" />
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1249820730792931328"
            target="_blank">2020/4/14 7:04:17</a></p>
      </header>
      <section>
        <p class="tweet-text">つまりパーサーに渡す段階で割と意味のあるトークン列（sqlite3ではToken構造体の列）になっているんだな。字句定義などがなくてすっきりした構文になっているのはそのせいなのだった。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1249833214752899074"
            target="_blank">2020/4/14 7:53:53</a></p>
      </header>
      <section>
        <p class="tweet-text">このチュートリアルも理解の助けになった。<br/><br/><blockquote class="card card-default"><header><div class="no-image" >No Image</div><a href="http://souptonuts.sourceforge.net/readme_lemon_tutorial.html" target="_blank"></a></header><div></div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1249833982084038656"
            target="_blank">2020/4/14 7:56:56</a></p>
      </header>
      <section>
        <p class="tweet-text">この例では数式の文字列はflexで字句解析を行いトークン配列化し、lemonで生成したparserに渡している。</p>
        
      </section>
      
    </article>
    
    <article>
      
      
      <header class="tweet-header">
        
        <img class="tweet-profile-img"  src="https://pbs.twimg.com/profile_images/731335621789147137/bWURa4wY_normal.jpg" />
        <p class="tweet-user-name">トモカズ@tomo0354</p>
        
        <p class="tweet-date"><a href="https://twitter.com/tomo0354/status/1249248746891665413"
            target="_blank">2020/4/12 17:11:25</a></p>
      </header>
      <section>
        <p class="tweet-text">PB-100実機でデジタルインベーダーを作りました。<br/>メモリの制約があって、かなりシンプルなルールになってしまった。（UFO出ません。弾数制限ありません）<br/>これで、残り5ステップです。<br/>「いかに少ないコードで作るか」というパズル的プログラミングですね。私は、苦手です。<br/><br/><a href="https://youtu.be/DUAVS9FEeTQ" target="_blank">youtu.be/DUAVS9FEeTQ</a></p>
        
      </section>
      
    </article>
    
    <article>
      
      
      <header class="tweet-header">
        
        <img class="tweet-profile-img"  src="https://pbs.twimg.com/profile_images/1212701145379946496/pSDVrvWj_normal.png" />
        <p class="tweet-user-name">S.F.@SFPGMR</p>
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248946874842636288"
            target="_blank">2020/4/11 21:11:53</a></p>
      </header>
      <section>
        <p class="tweet-text">V8のコードを読んでいてちょっと驚いたのはbit_cast。<br/>template &lt;class Dest, class Source&gt;<br/>V8_INLINE Dest bit_cast(Source const&amp; source) {<br/>static_assert(sizeof(Dest)== sizeof(Source),<br/>"source and dest must be same size");<br/>Dest dest;<br/>memcpy(&amp;dest, &amp;source, sizeof(dest));<br/>return dest;}</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248947496237199367"
            target="_blank">2020/4/11 21:14:22</a></p>
      </header>
      <section>
        <p class="tweet-text">これは異なる型に対して値のビット列を維持しながらキャストするもの。Dest型のワークを用意してmemcpyしてその値のコピーを返すというなかなかの荒技である。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248947792111734785"
            target="_blank">2020/4/11 21:15:32</a></p>
      </header>
      <section>
        <p class="tweet-text">static_assertを除くともうちょっとわかりやすい。これが必要な理由がコメントに書いてあった。<br/>template &lt;class Dest, class Source&gt;<br/>V8_INLINE Dest bit_cast(Source const&amp; source) {<br/>  Dest dest;<br/>  memcpy(&amp;dest, &amp;source, sizeof(dest));<br/>  return dest;<br/>}</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248948374167928833"
            target="_blank">2020/4/11 21:17:51</a></p>
      </header>
      <section>
        <p class="tweet-text">ふつう（というか私はC++11の手前あたりで知識が止まっているから普通じゃないかもしれん）はこういうときってポインタと絡ませたreinterpret_castを使ってやるんじゃないかと思うよね。でもそれの結果って未定義らしい。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248948937681014786"
            target="_blank">2020/4/11 21:20:05</a></p>
      </header>
      <section>
        <p class="tweet-text">規格上はね。コメントの例はこれ。<br/><br/>float f = 3.14159265358979;// WRONG<br/>int i = * reinterpret_cast&lt;int*&gt;(&amp;f);// WRONG<br/><br/>これは ISO C++ specification section 3.10 -15 -.によれば未定義の動作らしい。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248949809664249856"
            target="_blank">2020/4/11 21:23:33</a></p>
      </header>
      <section>
        <p class="tweet-text">よって結果が保障されるようにmemcpyで変換先の型のメモリに内容をコピーしてそれを返すようにしている。memcpy自体コストがかかりそうだが最適化されているのでそうでもないようだ。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248950261319524352"
            target="_blank">2020/4/11 21:25:21</a></p>
      </header>
      <section>
        <p class="tweet-text">Fortunately memcpy() is very fast.  In optimized mode, with a constant size, gcc 2.95.3, gcc 4.0.1, and msvc 7.1 produce inline code with the minimal amount of data movement.</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248950287328399360"
            target="_blank">2020/4/11 21:25:27</a></p>
      </header>
      <section>
        <p class="tweet-text">On a 32-bit system,memcpy(d,s,4) compiles to one load and one store, and memcpy(d,s,8)<br/>compiles to two loads and two stores.</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248950654476812295"
            target="_blank">2020/4/11 21:26:55</a></p>
      </header>
      <section>
        <p class="tweet-text">ということらしい。要するに4byteであれば1対のロード・ストア命令、8byteだと2対のロード・ストア命令にコンパイルされるそうだ。なるほどねえ。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248953513394073602"
            target="_blank">2020/4/11 21:38:16</a></p>
      </header>
      <section>
        <p class="tweet-text">なんかもう少しコメントを読むと、異なる型の式は異なるメモリを指しているという前提をオプティマイザに仮定させることが最適化の点で有効みたいなことが書いてあったな。とするとbit_castの動作はオプティマイザの動きにフィットした処理となるんだな。おそらく。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248953791698751490"
            target="_blank">2020/4/11 21:39:23</a></p>
      </header>
      <section>
        <p class="tweet-text">うーむ。C++はやっぱり難しいけど奥が深くて面白い言語ですな。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248957740866666497"
            target="_blank">2020/4/11 21:55:04</a></p>
      </header>
      <section>
        <p class="tweet-text">「ISO C++ 3.10 -15-の目的は、最適化コンパイラが異なる型の式が異なるメモリを参照していると仮定できるようにすることです。」だそうだ。</p>
        
      </section>
      
    </article>
    
    <article>
      
      
      <header class="tweet-header">
        
        <img class="tweet-profile-img"  src="https://pbs.twimg.com/profile_images/1212701145379946496/pSDVrvWj_normal.png" />
        <p class="tweet-user-name">S.F.@SFPGMR</p>
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248866826743771138"
            target="_blank">2020/4/11 15:53:48</a></p>
      </header>
      <section>
        <p class="tweet-text">続いてIsInt32Double()のほうを見てみようか。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248867688387993600"
            target="_blank">2020/4/11 15:57:14</a></p>
      </header>
      <section>
        <p class="tweet-text">こういう関数ですな。Int32がとる範囲内かつマイナス0でないかつ値がFastI2D(FastD2I(value))とvalueが等しいと整数だと。<br/>bool IsInt32Double(double value) {<br/>return value &gt;= kMinInt &amp;&amp; value &lt;= kMaxInt &amp;&amp; !IsMinusZero(value) &amp;&amp;<br/>  value == FastI2D(FastD2I(value));<br/>}</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248870300655075328"
            target="_blank">2020/4/11 16:07:37</a></p>
      </header>
      <section>
        <p class="tweet-text">-0というのはDoubleだと63ビット目が1になってあとは0となるんだよな。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248870785923436546"
            target="_blank">2020/4/11 16:09:32</a></p>
      </header>
      <section>
        <p class="tweet-text">しかしなぜ-0でないことを確認せねばならないのだろうか。+0でも-0でも0だから整数とみなしてもいいはず。。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248871093424685057"
            target="_blank">2020/4/11 16:10:46</a></p>
      </header>
      <section>
        <p class="tweet-text"><blockquote class="card card-default"><header><div class="no-image" >No Image</div><a href="https://ja.wikipedia.org/wiki/IEEE_754%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E8%B2%A0%E3%81%AE%E3%82%BC%E3%83%AD" target="_blank">IEEE 754における負のゼロ - Wikipedia</a></header><div></div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248871945577172992"
            target="_blank">2020/4/11 16:14:09</a></p>
      </header>
      <section>
        <p class="tweet-text">よくわからんが、次のvalue == FastI2D(FastD2I(value))と関係があるのかもしれないな。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248873094657146881"
            target="_blank">2020/4/11 16:18:43</a></p>
      </header>
      <section>
        <p class="tweet-text">FastD2I()というのはこれ<br/>inline int FastD2I(double x) {<br/>  DCHECK(x &lt;= INT_MAX);<br/>  DCHECK(x &gt;= INT_MIN);<br/>  return static_cast&lt;int32_t&gt;(x);<br/>}<br/><br/>DCHECK()はデバッグ時はassertとなるマクロ。要は単純にstatic_castしてるだけですな。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248873580726636551"
            target="_blank">2020/4/11 16:20:39</a></p>
      </header>
      <section>
        <p class="tweet-text">そしてFastI2D()というのはこれ。まあこれも単純にstatic_castしてdoubleに戻しているだけ。<br/>inline double FastI2D(int x) {<br/>  return static_cast&lt;double&gt;(x);<br/>}</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248874868671516675"
            target="_blank">2020/4/11 16:25:46</a></p>
      </header>
      <section>
        <p class="tweet-text">ようするに「double値をint32_tでキャストして整数化→整数化したものをdoubleにキャストしてもとに戻した結果」が「もとの値と同じ」であればそれは「整数」ということなるんだな。当たり前といえば当たり前。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248875275149963264"
            target="_blank">2020/4/11 16:27:23</a></p>
      </header>
      <section>
        <p class="tweet-text">このキャストは、<br/>・値がInt32のとる範囲外<br/>・少数を含む<br/>場合はおそらく等しくないよな。なのでそれはInt32でないといえる。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248875373430857729"
            target="_blank">2020/4/11 16:27:46</a></p>
      </header>
      <section>
        <p class="tweet-text">等しくないというか元の値ではなくなるよな。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248875459921629184"
            target="_blank">2020/4/11 16:28:07</a></p>
      </header>
      <section>
        <p class="tweet-text">ではマイナス0ではどうなるのか。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248877913736273921"
            target="_blank">2020/4/11 16:37:52</a></p>
      </header>
      <section>
        <p class="tweet-text">試してみたけど整数として判定されるな。<br/><br/><blockquote class="card card-default"><header><div class="no-image" >No Image</div><a href="https://wandbox.org/permlink/sZ7yrtkKu2q5iWCY" target="_blank">[Wandbox]三へ( へ՞ਊ ՞)へ ﾊｯﾊｯ</a></header><div></div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248878005465657344"
            target="_blank">2020/4/11 16:38:14</a></p>
      </header>
      <section>
        <p class="tweet-text">wandbox便利ですな。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248878681155497984"
            target="_blank">2020/4/11 16:40:55</a></p>
      </header>
      <section>
        <p class="tweet-text">しかしなぜIsInt32Double()は-0を整数で「ない」と判定するのだろうか。なんか意味があるはずだ。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248888505020715008"
            target="_blank">2020/4/11 17:19:57</a></p>
      </header>
      <section>
        <p class="tweet-text">Wikipediaに少しヒントとなるようなことが書いてあるな。。<br/><br/>「計算結果が負の極めて小さい値で算術アンダーフローとなった場合、負のゼロが結果として得られる。」<br/><br/>しかし単に-0.0や-0.0 x 1.0も負のゼロとなるようだが。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248896008026615808"
            target="_blank">2020/4/11 17:49:46</a></p>
      </header>
      <section>
        <p class="tweet-text">ちょっとしょぼいコードで申し訳ないが、doubleのビットパターンを表示してみたらやっぱり-0.0x1.0は-0になるね。。 https://t.co/aEv0RlhPxu</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/EVT3y0aU4AA-2gQ.png" />
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/EVT38oYUEAAPUQN.png" />
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248896544729788416"
            target="_blank">2020/4/11 17:51:54</a></p>
      </header>
      <section>
        <p class="tweet-text">いや、これって「整数演算の範囲では-0というのはあり得ない値だから」だからじゃないだろうか。なんかそんな気がするな。</p>
        
      </section>
      
    </article>
    
    <article>
      
      
      <header class="tweet-header">
        
        <img class="tweet-profile-img"  src="https://pbs.twimg.com/profile_images/1212701145379946496/pSDVrvWj_normal.png" />
        <p class="tweet-user-name">S.F.@SFPGMR</p>
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244045709982101504"
            target="_blank">2020/3/29 8:36:25</a></p>
      </header>
      <section>
        <p class="tweet-text">今ちょっとsqlite3のnodeバインディングである「node-sqlite3」の「node-sqlcipher」をいじって、Promiseベースのインターフェースへの書き換えを試みようとして、いろいろ調べているところである。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244046323533246464"
            target="_blank">2020/3/29 8:38:51</a></p>
      </header>
      <section>
        <p class="tweet-text">sqlcipherはsqlite3のデータを暗号化することができる以外はsqlite3と同じである。そしてnode-sqlcipherはnode-sqlite3とはバインディング先のモジュールが「sqlite3」なのか、「sqlcipher」なのかの違いだけで、JSから見たAPIは同じものである。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244047077669081088"
            target="_blank">2020/3/29 8:41:51</a></p>
      </header>
      <section>
        <p class="tweet-text">sqlite3はロック粒度が「ファイル単位」であり、ローカルのアプリ（主に1人で使うもの）に向いている。サーバー側の認証情報を持っておくような用途には向いていない。が、扱いが簡単で同時実行制御機能もなくはないので小規模なものなら運用できそうではある。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244047959286632449"
            target="_blank">2020/3/29 8:45:21</a></p>
      </header>
      <section>
        <p class="tweet-text">sqlite3に行レベルのロックを設ければロック競合の問題がある程度回避できるので、そのような実装を行った例もあるようだ。<br/><a href="https://www.ieice.org/publications/conference-FIT-DVDs/FIT2018/data/pdf/D-016.pdf" target="_blank">ieice.org/publications/c…</a></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244048737191649280"
            target="_blank">2020/3/29 8:48:26</a></p>
      </header>
      <section>
        <p class="tweet-text">それはさておき、Native Addonを作るには？だけどこれはなかなか大変である。私のようなド素人にとっては。環境自体どう作ったらよいかわからない。しかもnodeは複数のOSで動かすから、それぞれのOSでコンパイルできるようにしないといけない。しかしそのような環境は私にはない。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244049223185600513"
            target="_blank">2020/3/29 8:50:22</a></p>
      </header>
      <section>
        <p class="tweet-text">かろうじてwsl2とWindows 10はあるのでlinux/windows に関してはコンパイルして試すということができそうだが。しかしnode.jsで遊ぶ限りlinux(wsl2)の居心地が良すぎてここ1－2年はwindowsのバイナリでnodeアプリケーションを動かしてない。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244049574072733696"
            target="_blank">2020/3/29 8:51:46</a></p>
      </header>
      <section>
        <p class="tweet-text">私のようなレベルでも路頭に迷わないようにいろいろなものが用意されているのだが、いろいろありすぎてわけがわからない。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244050144292507649"
            target="_blank">2020/3/29 8:54:02</a></p>
      </header>
      <section>
        <p class="tweet-text">まずはnodeにはnode-gypが用意されていて、これを使うことによってOS間のビルド環境の差を吸収してくれるようである。そういうものがあるというのは知ってはいるがあくまでモジュールのインストールで言葉として出てくるだけで内容はほとんど知らないに等しい。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244051463438917632"
            target="_blank">2020/3/29 8:59:16</a></p>
      </header>
      <section>
        <p class="tweet-text">node-gypというのはgypのnodeバインディングということである。gypといのはGenerate Your Projectの略である。もともとchromiumのビルドを行うために作られたものらしい。ただchromiumはgypからgnというのに移行したらしいが。nodeはgypを使い続けるらしい。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244052294456377344"
            target="_blank">2020/3/29 9:02:35</a></p>
      </header>
      <section>
        <p class="tweet-text">gypというのはクロスプラットフォーム・ビルドシステムでmakeやcmakeとかの類かなと思ってたんだけど、違った。gypは「メタ・ビルドシステム」とのこと。つまり<br/>メタ・ビルドスクリプトを書いて、複数のビルド・システムのビルドスクリプトを生成するツールなのだった。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244052574161866752"
            target="_blank">2020/3/29 9:03:41</a></p>
      </header>
      <section>
        <p class="tweet-text">gypで書いたスクリプトはmakeやcmake、nmakeがそれぞれ解釈できるスクリプトに翻訳されるわけですな。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244053391321346049"
            target="_blank">2020/3/29 9:06:56</a></p>
      </header>
      <section>
        <p class="tweet-text">つまりnodeのNative Addon開発者は<br/>1. gypでビルドスクリプトを書く<br/>2. 対応するビルドシステムのビルドスクリプトを出力<br/>3. 対応するビルドシステムでビルド<br/><br/>とこういうステップでビルドを進めないといけないわけですな。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244070471093465089"
            target="_blank">2020/3/29 10:14:48</a></p>
      </header>
      <section>
        <p class="tweet-text">でnode-gyp使ってHello World的なNative Addonを作ってみる。<br/><blockquote class="card card-default"><header><img  src="https://avatars1.githubusercontent.com/u/9950313?s=400&v=4" /><a href="https://github.com/nodejs/node-gyp" target="_blank">GitHub - nodejs/node-gyp: Node.js native addon build tool</a></header><div>Node.js native addon build tool. Contribute to nodejs/node-gyp development by creating an account on GitHub.</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244071854601465856"
            target="_blank">2020/3/29 10:20:18</a></p>
      </header>
      <section>
        <p class="tweet-text">mkdir na<br/>cd na<br/>npm init<br/><br/>はまあいつもの感じですわな。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244072960752668672"
            target="_blank">2020/3/29 10:24:42</a></p>
      </header>
      <section>
        <p class="tweet-text">そして<br/><br/>npm i node-gyp<br/><br/>を入れると。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244073142068236288"
            target="_blank">2020/3/29 10:25:25</a></p>
      </header>
      <section>
        <p class="tweet-text">そしてbinding.gypファイルを作る。<br/><br/><blockquote class="card card-default"><header><img  src="https://avatars1.githubusercontent.com/u/9950313?s=400&v=4" /><a href="https://github.com/nodejs/node-gyp#the-bindinggyp-file" target="_blank">GitHub - nodejs/node-gyp: Node.js native addon build tool</a></header><div>Node.js native addon build tool. Contribute to nodejs/node-gyp development by creating an account on GitHub.</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244169506441715713"
            target="_blank">2020/3/29 16:48:20</a></p>
      </header>
      <section>
        <p class="tweet-text">Native Addonを作る方法はいくつかあるようだ。<br/><br/>1.  v8とlibuvのAPIで頑張る<br/>2. nanを使う<br/>3. N-APIを使う<br/>4. node-addon-apiを使う</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244172766581907456"
            target="_blank">2020/3/29 17:01:17</a></p>
      </header>
      <section>
        <p class="tweet-text">■V8のAPIを直接叩くとV8の頻繁な変更に対応するのが大変→抽象化して再コンパイルだけで対応できることを目指したものがnan<br/>■jsのエンジンの差し替え等も考慮したより抽象度の高いABIを持つものがN-API。そしてそれをC++でラップしたのがnode-addon-api<br/><br/>ということのようだ。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244173798548451328"
            target="_blank">2020/3/29 17:05:23</a></p>
      </header>
      <section>
        <p class="tweet-text">この辺ちょっと理解が進んだ。確かにN-APIはサンプルコード読んでもv8::とか出てこんもんな。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244174651795767297"
            target="_blank">2020/3/29 17:08:47</a></p>
      </header>
      <section>
        <p class="tweet-text">node-addon-apiを使ったサンプルコードのコンパイル・実行は比較的簡単であった。<br/><br/>npm init<br/><br/>npm i node-gyp<br/>npm i bindings<br/>npm i node-addon-api<br/><br/>を入れ、binding.gypを書くだけでよかった。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244175045846425601"
            target="_blank">2020/3/29 17:10:21</a></p>
      </header>
      <section>
        <p class="tweet-text">いちからだとpythonやgccとかのインストールがいるんだろうけど、npmでモジュールを入れてnodeを使っている時点でその辺はクリアできているので必要なかった。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244175306644021253"
            target="_blank">2020/3/29 17:11:23</a></p>
      </header>
      <section>
        <p class="tweet-text">binding.gypの中身はこんな感じ。include_dirsの中身はさっぱりわからんが。<br/>{<br/>  "targets": [<br/>    {<br/>      "target_name": "na",<br/>      "include_dirs": ["&lt;!@(node -p \"require('node-addon-api').include\")"],<br/>      "sources": [ "src/na.cc" ]<br/>    }<br/>  ]<br/>}</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244175495643553792"
            target="_blank">2020/3/29 17:12:08</a></p>
      </header>
      <section>
        <p class="tweet-text">そして<blockquote class="card card-default"><header><div class="no-image" >No Image</div><a href="http://na.cc" target="_blank">news aktuell macht Ihre Kommunikation erfolgreicher</a></header><div></div></blockquote>にコードを書いてnpm i するだけでモジュールができた。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244175688015331330"
            target="_blank">2020/3/29 17:12:54</a></p>
      </header>
      <section>
        <p class="tweet-text">js側のコードはこんな感じ。<br/><br/>import binding from 'bindings';<br/>const addon = binding('na');<br/>console.log(<a href="http://addon.na" target="_blank">addon.na</a>()); // 'world'</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244176032891949056"
            target="_blank">2020/3/29 17:14:16</a></p>
      </header>
      <section>
        <p class="tweet-text"><blockquote class="card card-default"><header><div class="no-image" >No Image</div><a href="http://na.cc" target="_blank">news aktuell macht Ihre Kommunikation erfolgreicher</a></header><div></div></blockquote>はnode-addon-apiのまんま。。メソッドの名前を変えただけですわ。。 https://t.co/jDLTbhVqWf</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/EUQzUa6UcAE8POg.png" />
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244180592188485633"
            target="_blank">2020/3/29 17:32:23</a></p>
      </header>
      <section>
        <p class="tweet-text">まあここまでは誰でもできますわなあ。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244189837223014401"
            target="_blank">2020/3/29 18:09:07</a></p>
      </header>
      <section>
        <p class="tweet-text">VSCodeのsettings.jsonでC_Cpp.default.includePathにnapi.h関連のヘッダが通るように設定したらintellisenseも効くな。。 https://t.co/sZGEcYSCEl</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/EUQ_gyQU4AM4AT1.png" />
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244189908719136768"
            target="_blank">2020/3/29 18:09:24</a></p>
      </header>
      <section>
        <p class="tweet-text">なんかすげえ。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244204645691445248"
            target="_blank">2020/3/29 19:07:58</a></p>
      </header>
      <section>
        <p class="tweet-text">スーパーナチュラル観ながら合間にコード書いてるので全然進まん。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244205943224598528"
            target="_blank">2020/3/29 19:13:07</a></p>
      </header>
      <section>
        <p class="tweet-text">gypの書き方も覚えんといかんな。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244208837709590528"
            target="_blank">2020/3/29 19:24:37</a></p>
      </header>
      <section>
        <p class="tweet-text">node-sqlcipher/sqlite3はdepsディレクトリに本体のtarファイルが入っていて、これをextract.piで解凍してビルドしてるんだよな。でそれをgypでビルドするために<br/><br/>・common-sqlite.gypi<br/>・sqlite3.gyp<br/><br/>の2つのファイルがあるようだ。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244210332978917377"
            target="_blank">2020/3/29 19:30:34</a></p>
      </header>
      <section>
        <p class="tweet-text">いや違うな。sqlite3.gypの中で<a href="http://extract.py" target="_blank">extract.py</a>を呼び出してtarファイルを解凍してるわ。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244210516819492867"
            target="_blank">2020/3/29 19:31:18</a></p>
      </header>
      <section>
        <p class="tweet-text">gypの前にmakeを勉強していたので、中身はなんとなくわからんでもない。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244211350659674112"
            target="_blank">2020/3/29 19:34:36</a></p>
      </header>
      <section>
        <p class="tweet-text">ちなみにnode-sqlite3/sqlcipherはnanで作られてる。これをちょっとn-apiに書き換えてみようかなあと思うんだよね。。ハードルはかなり高いけどね。その時にpromiseベースに改造しようかなと。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244394122779090944"
            target="_blank">2020/3/30 7:40:53</a></p>
      </header>
      <section>
        <p class="tweet-text">今朝nanベースのsqlcipherバインディングであるnode-sqlcipherのコードを読み直している。N-APIに比べるとやはりnanはかなり薄いラッパーであることがわかる。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244396257348476928"
            target="_blank">2020/3/30 7:49:22</a></p>
      </header>
      <section>
        <p class="tweet-text">N-APIのリファレンスを見る限りv8やlibuvへのAPIに対する作業はほぼ内部的に処理され隠ぺいされている。ただしnode-sqlcipherはdbへの同期・非同期処理を実現するために独自のqueueを内部に持ち、非同期処理はuv_work_queue()を使って行っているからlibuvを直接いじるコードはそのまま残りそうだ。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244397018966921216"
            target="_blank">2020/3/30 7:52:23</a></p>
      </header>
      <section>
        <p class="tweet-text">dbへの作業をすべてpromiseベースにし、実行に関するスケジューリングはpromise/asyncで行う（つまりJS側でスケジューリングする）ようにすると内部的なスケジューラはいらなくなるのかもしれない。もうちょっとコードを深く理解しないと確定的なことはいえないが。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244397930213072896"
            target="_blank">2020/3/30 7:56:01</a></p>
      </header>
      <section>
        <p class="tweet-text">それのメリットとしてはlibuvに依存するコードがアドオンからなくなるのでポータビリティがより高まるということなんだけどね。内部的なスケジューリングはひょっとすると他の方法（例えばN-APIが持つ非同期の機能やスレッディング機能）で実現できるのかもしれんが、今はよくわからない。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244398870672494592"
            target="_blank">2020/3/30 7:59:45</a></p>
      </header>
      <section>
        <p class="tweet-text">しばらくはコードやAPIのドキュメントを読む日が続きますな。しかし思いのほかビルドまでのステップが簡単で済んでよかった。私のような趣味レベルだと、その環境整備だけでおなか一杯になってそのあと放置してしまうこと多々あるので。過去にそのような残骸が十数個くらいあると思う。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244399878400172032"
            target="_blank">2020/3/30 8:03:45</a></p>
      </header>
      <section>
        <p class="tweet-text">node-sqlcipher/sqlite3だとnode-gyp,node-addon-api,bindingsをnpmで追加するくらいで、N-APIへの改造が可能になるんだよね。forkしたのに追加して勉強しながらぼちぼちコードを書き換えていくスタイルで進めていこうと思う。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244400289223831552"
            target="_blank">2020/3/30 8:05:23</a></p>
      </header>
      <section>
        <p class="tweet-text">ただビルドスクリプトを見るに、electronへのサポートも入ってた。確かelectronって少しネイティブ・アドオンのABIが違ってたと思うんだよな。ちょっとそこが気になってるけどね。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244429131393064960"
            target="_blank">2020/3/30 9:59:59</a></p>
      </header>
      <section>
        <p class="tweet-text">ここを読んでる。<br/><blockquote class="card card-default"><header><img  src="https://avatars1.githubusercontent.com/u/9950313?s=400&v=4" /><a href="https://github.com/nodejs/node-addon-api/blob/master/doc/async_operations.md" target="_blank">node-addon-api/async_operations.md at master · nodejs/node-addon-api · GitHub</a></header><div>Module for using N-API from C++. Contribute to nodejs/node-addon-api development by creating an account on GitHub.</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244610403495108609"
            target="_blank">2020/3/30 22:00:18</a></p>
      </header>
      <section>
        <p class="tweet-text">AsyncWorkerとPromise::Defferedの組み合わせた使い方。。<br/><br/><a href="https://cdn2.hubspot.net/hubfs/106921/2020_Content%20Files/Tech%20White%20Paper%20%5BTWP%5D-Tech%20Blog%20%5BTBL%5D/Technical-Whitepaper-Next-Generation-Native-Node-Stephen-Brooks-2020.pdf" target="_blank">cdn2.hubspot.net/hubfs/106921/2…</a></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244610736891908096"
            target="_blank">2020/3/30 22:01:38</a></p>
      </header>
      <section>
        <p class="tweet-text">これのAnswerも参考になるかなあと。。<br/><br/><blockquote class="card card-default"><header><div class="no-image" >No Image</div><a href="https://www.gitmemory.com/issue/nodejs/node-addon-examples/85/551142933" target="_blank">Can you create example for async promise? - node-addon-examples</a></header><div></div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244610928919769088"
            target="_blank">2020/3/30 22:02:23</a></p>
      </header>
      <section>
        <p class="tweet-text">なんかいけそうな気がしてきたな。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244753206128726016"
            target="_blank">2020/3/31 7:27:45</a></p>
      </header>
      <section>
        <p class="tweet-text">恐る恐るC++コードを書き始める。。 https://t.co/GkR2xq9UkO</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/EUZAYsuU4AEqoNQ.png" />
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244753696459636737"
            target="_blank">2020/3/31 7:29:42</a></p>
      </header>
      <section>
        <p class="tweet-text">このコードのコンパイルを通すの結構大変だった。やはりgypの内容をある程度理解することが必要。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244836352425742337"
            target="_blank">2020/3/31 12:58:09</a></p>
      </header>
      <section>
        <p class="tweet-text">とりあえずsqlcipherではなくて、sqlite3ベースでまず作ろう。暗号化部分をどうするかは後で考えよう。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244960393501405184"
            target="_blank">2020/3/31 21:11:02</a></p>
      </header>
      <section>
        <p class="tweet-text">ちゅうかどっちでもいいか。。データベース本体を作ってるわけではなく、薄いラッパーを書こうとしてるだけだからね。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245481641956347911"
            target="_blank">2020/4/2 7:42:18</a></p>
      </header>
      <section>
        <p class="tweet-text">コードを書き始めている。がかなりの遅筆。そういえば参照っちゅうのがあったなあ。。とか参照はコンストラクタのイニシャライザ以外では初期化できんとかなあとか、constはJSと違って割と本物だなあとか、いろいろ思い出しながら書いてる。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245482881943658498"
            target="_blank">2020/4/2 7:47:13</a></p>
      </header>
      <section>
        <p class="tweet-text">が、このJS &lt;--&gt;C++間の情報をやりとりするためのコストは馬鹿にならないなあとコードを書くとより強く思う。こういう汎用なラッパーよりも、自分のアプリに特化したアドオンを作るほうがあたりまえだが効率はいいんだよな。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245484915929403393"
            target="_blank">2020/4/2 7:55:18</a></p>
      </header>
      <section>
        <p class="tweet-text">例えば認証部分を作る場合汎用ラッパーだとJSで<br/><br/>1. dbオープン<br/>2.クエリ発行、照合<br/>3.結果返却<br/><br/>まで書くけど、自前ネイティブ・アドオンならJS側は<br/>const user = await addon.login(user,pass);<br/>としてアドオンで上の処理を行えばJSとC++間の情報のやりとりが減ってパフォーマンスもよくなる。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245485667536097280"
            target="_blank">2020/4/2 7:58:17</a></p>
      </header>
      <section>
        <p class="tweet-text">とりあえず勉強がてら汎用的なアドオンを書いてみたいので続けるけど、実際使うものはもうちょっとアプリよりの汎用性のないものを作ろうかなあと思ったりしてるところである。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245832669046263809"
            target="_blank">2020/4/3 6:57:09</a></p>
      </header>
      <section>
        <p class="tweet-text">AsyncWorkerとPromiseを使ったsqlite3 dbのopen/closeのメソッドがとりあえず動いた。AsyncWorkerの実装はなかなかコード量が多い。といってもパターン化できるのでコピペ＋書き換えで済みそうだけど。 https://t.co/v34hXJjU5T</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/EUoWJkRUUAACN7m.png" />
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245832918800281601"
            target="_blank">2020/4/3 6:58:08</a></p>
      </header>
      <section>
        <p class="tweet-text">JS側はこんなテストコードを書いた。 https://t.co/FLOFH1enGL</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/EUoWZPaVAAs7ljZ.png" />
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245833202414972928"
            target="_blank">2020/4/3 6:59:16</a></p>
      </header>
      <section>
        <p class="tweet-text">ちなみに先ほどのスクショのコードだと以下のエラーが出る。<br/>TypeError: Option Paramater is missing.<br/>    at file:///home/sfpg/pj/node-sqlcipher/test/napi-test.mjs:7:12<br/>    at file:///home/sfpg/pj/node-sqlcipher/test/napi-test.mjs:12:3</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245833786035597312"
            target="_blank">2020/4/3 7:01:35</a></p>
      </header>
      <section>
        <p class="tweet-text">２つ目のパラメータが文字列ではなく整数値を期待しているのでそれ以外だとエラーが出るテストをしてた。C++例外がJSに伝搬するとドキュメントに書いてあったのでそのテストをしてみてたところ。。<br/><blockquote class="card card-default"><header><img  src="https://avatars1.githubusercontent.com/u/9950313?s=400&v=4" /><a href="https://github.com/nodejs/node-addon-api/blob/master/doc/error_handling.md#handling-errors-with-c-exceptions" target="_blank">node-addon-api/error_handling.md at master · nodejs/node-addon-api · GitHub</a></header><div>Module for using N-API from C++. Contribute to nodejs/node-addon-api development by creating an account on GitHub.</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245834669813149696"
            target="_blank">2020/4/3 7:05:06</a></p>
      </header>
      <section>
        <p class="tweet-text">エラーチェック部分のコードは以下<br/>if(info[1].IsNumber()){<br/>  mode = static_cast&lt;int&gt;(info[1].As&lt;Napi::Number&gt;());<br/>} else {<br/>  throw Napi::TypeError::New(env, "Option Paramater is missing.");<br/>}<br/><br/>普通にC++側でエラーをthrowするとそれがJS側に伝えられる。 https://t.co/hBu54TTI01</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/EUoXpZGUwAErn3T.png" />
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245835813230743552"
            target="_blank">2020/4/3 7:09:39</a></p>
      </header>
      <section>
        <p class="tweet-text">あとこのoptionというかオープンするときのパラメータはJSだとふつうオブジェクトで指定する。これをC++側で受け取ってint型の整数にまとめるようにしないといけないかなと思っている。なんかC++側の定数もJSにexportできるみたいなんで、C風にビットパターンorで指定するのでいいかもしれないが。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245836862293344256"
            target="_blank">2020/4/3 7:13:49</a></p>
      </header>
      <section>
        <p class="tweet-text">open/close部分だけでもかなりのコード量になっているが、まだまだ実用に乏しい実装で、もう少しいろいろ考えないといけない気もしている。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245838053823762433"
            target="_blank">2020/4/3 7:18:33</a></p>
      </header>
      <section>
        <p class="tweet-text">C++のクラスをJSのオブジェクトにラップするにはNapi::ObjectWrap&lt;&gt;を継承するんだけど、これテンプレートパラメータは＜継承する子クラス＞になってるんだよね。これってCRTPとかいうやつだよな。。 https://t.co/niVvj6CU3H</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/EUoahyQUwAUIgAg.png" />
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245838712321101826"
            target="_blank">2020/4/3 7:21:10</a></p>
      </header>
      <section>
        <p class="tweet-text">昔ATLとかWTLをいじってたことがあるが、これはもろCRTPを使ったライブラリであった。静的ポリモーフィズムを実現するためのテクニックだよな。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245839097903452160"
            target="_blank">2020/4/3 7:22:42</a></p>
      </header>
      <section>
        <p class="tweet-text">仮想関数のオーバーヘッドを気にしていた時代というのがあって、そのころに生み出されたものではないかなと思うけどね。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245840450969145345"
            target="_blank">2020/4/3 7:28:04</a></p>
      </header>
      <section>
        <p class="tweet-text">「Curiously Recurring Template Pattern」の略で、「奇妙な再帰テンプレートパターン」とでも訳すのだろうか。具象クラスを基底クラスに伝えるというのがなんとも不思議な感じが当時したものだ。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245841552921915392"
            target="_blank">2020/4/3 7:32:27</a></p>
      </header>
      <section>
        <p class="tweet-text">node-sqlite3と同じようにデータベースとステートメントに分けて実装しようと思う。これはsqlite3のハンドルポインタを考えれば自然とそうなるんだけども。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245842117328437249"
            target="_blank">2020/4/3 7:34:42</a></p>
      </header>
      <section>
        <p class="tweet-text">ハンドル（ポインタ）= インスタンス番号なのでそれをクラスメンバとして、そのハンドルのAPIをメンバ関数としてラップするのが自然な感じになるんだよな。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245842839491076097"
            target="_blank">2020/4/3 7:37:34</a></p>
      </header>
      <section>
        <p class="tweet-text">Cでオブジェクト指向的なアプローチをやろうとするとsqlite3のようなAPIになるんだよな。引数としてハンドルを渡す、つまりこれがthisポインタの代わりで、そこから情報を引き出して処理を行う感じ。Windows APIなんかもそんな感じですわな。HWND。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245844681767952384"
            target="_blank">2020/4/3 7:44:53</a></p>
      </header>
      <section>
        <p class="tweet-text">node-sqlite3では非同期処理やコールバックのためlibuvにうまくなじむようにBatonパターンちゅうので処理が細かく分割され実装されている。そのあたりの実装はAsyncWorkerに置き換えることでかなり実装が簡略化できそうな気がしている。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245845727940505601"
            target="_blank">2020/4/3 7:49:02</a></p>
      </header>
      <section>
        <p class="tweet-text">さらにnode-sqlite3では内部に実行スケジューラを持っていて直列・並列処理のコントロールを行っているが、今回Promiseベースのインターフェースで行うので、実行スケジューリングはJSのasync/awaitやPromise.all/race/thenあたりでするのでスケジューラは不要になる予定。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245845909641916416"
            target="_blank">2020/4/3 7:49:46</a></p>
      </header>
      <section>
        <p class="tweet-text">「最後まで飽きずに実装できれば」の話ですが。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245889606983143425"
            target="_blank">2020/4/3 10:43:24</a></p>
      </header>
      <section>
        <p class="tweet-text">sqlite3.exec()ってコールバックで行データを返すのね。。これの対応どうしようかなあ。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246020954183962625"
            target="_blank">2020/4/3 19:25:20</a></p>
      </header>
      <section>
        <p class="tweet-text">コールバックが終わるまではPromise::resolve()しないようにしたらいいんだよな。コールバックとPromiseを併用するという奇妙なインターフェース。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246022450854297601"
            target="_blank">2020/4/3 19:31:16</a></p>
      </header>
      <section>
        <p class="tweet-text">node native addonのコードを書いていて思い出すのはdisp interfaceとかdual interfaceとか、ActiveX Objectのプログラミングですわな。。ATLでブラウザのコンポーネントを書いたり、WSHのオブジェクト書いたりとか。あれもまあよく出来たライブラリでしたなあ。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246023302318977026"
            target="_blank">2020/4/3 19:34:39</a></p>
      </header>
      <section>
        <p class="tweet-text">まだまだ分からんところが多いので、リークしないか気になっている。あれ、そういえばWSL2上のC++のコードをVS Codeでデバッグするのどうやるんだ（笑）。今のところprintfデバッグならぬstd::coutデバッグでやってるが（笑）。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246023716456124416"
            target="_blank">2020/4/3 19:36:18</a></p>
      </header>
      <section>
        <p class="tweet-text">そういえばなんかデバッグビルドでメモリ・リークチェックができたような気もするな。ああ、デバッグするにはデバッグバージョンでビルドしないといけないんだった！（笑）</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246040844903182336"
            target="_blank">2020/4/3 20:44:22</a></p>
      </header>
      <section>
        <p class="tweet-text">まあしかし、私がC++で遊べたのはやはりVisual Studio IDEのおかげなんだよなあ。コンパイル・デバッグがあんなに簡単にできるというのはやはりソフトウェアが優秀だったからということですわな。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246041074797166592"
            target="_blank">2020/4/3 20:45:17</a></p>
      </header>
      <section>
        <p class="tweet-text">多分VS Codeでエクステンションをほにゃららすれば比較的簡単にできるんだろうけど、明日試そう。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246207153737592832"
            target="_blank">2020/4/4 7:45:13</a></p>
      </header>
      <section>
        <p class="tweet-text">考えたらnodeのアドオンだからデバッグはそれなりに工夫は必要かもね。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246207675425144832"
            target="_blank">2020/4/4 7:47:17</a></p>
      </header>
      <section>
        <p class="tweet-text">HandleScopeの使いどころがいまいちわからんな。。オブジェクトをスイープされないようにするために使うのはわかるのだが。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246211634055372802"
            target="_blank">2020/4/4 8:03:01</a></p>
      </header>
      <section>
        <p class="tweet-text">AsyncWorker::Execute()中でのnode addon apiの呼び出しはできないのか。。そりゃそうか。。<br/><br/>As the method is not running on the main event loop, it must avoid calling any methods from node-addon-api or running any code that might invoke JavaScript.</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246213824014766081"
            target="_blank">2020/4/4 8:11:43</a></p>
      </header>
      <section>
        <p class="tweet-text">sqlite3_execのコールバックをきちんと処理するにはThreadSafeFunctionを使うほうがよさそうですな。。<br/><br/><blockquote class="card card-default"><header><img  src="https://avatars1.githubusercontent.com/u/9950313?s=400&v=4" /><a href="https://github.com/nodejs/node-addon-api/blob/master/doc/threadsafe_function.md" target="_blank">node-addon-api/threadsafe_function.md at master · nodejs/node-addon-api · GitHub</a></header><div>Module for using N-API from C++. Contribute to nodejs/node-addon-api development by creating an account on GitHub.</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246214786464899073"
            target="_blank">2020/4/4 8:15:33</a></p>
      </header>
      <section>
        <p class="tweet-text">ただまあsql injectionとか考えると、これでクエリすることはなさそうだし、返却値も型情報が失われ、テキストデータとして返されるから使い所は限られるかもね。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246215384480403456"
            target="_blank">2020/4/4 8:17:55</a></p>
      </header>
      <section>
        <p class="tweet-text">node_sqlite3がsqlite3_execのコールバックをサポートしないのも納得できるな。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246215801448742912"
            target="_blank">2020/4/4 8:19:35</a></p>
      </header>
      <section>
        <p class="tweet-text">なんだろうな、こういう言語間をつなぐ糊のようなコードを書くのもなかなか楽しいよな。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246216479336357888"
            target="_blank">2020/4/4 8:22:16</a></p>
      </header>
      <section>
        <p class="tweet-text">AsyncWorker::Execute中から行データを一行づつjsにコールバックしようとしてたが、それは仕様上できないということがわかったので、ThreadSafeFunctionで試してみることにしよう。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246216987937669121"
            target="_blank">2020/4/4 8:24:18</a></p>
      </header>
      <section>
        <p class="tweet-text">さっきHandleScopeの使い所で悩んでたけど、そりゃあかんわな。。AsyncWorker::Execute()中ではそもそも使えないもんね。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246415638702125058"
            target="_blank">2020/4/4 21:33:40</a></p>
      </header>
      <section>
        <p class="tweet-text">ようやくsqlite3_execのラッパー部分がJSで動くようになった。が、かなり不安定だ。。 https://t.co/C7OsOpwDlU</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/EUwoC8OUcAM0Pgt.png" />
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246416284184535041"
            target="_blank">2020/4/4 21:36:14</a></p>
      </header>
      <section>
        <p class="tweet-text">コールバックでデータを返すところで、ある条件下でsegmentation faultになってしまう。ウーム。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246600457696374784"
            target="_blank">2020/4/5 9:48:04</a></p>
      </header>
      <section>
        <p class="tweet-text">昨日のトラブルはコールバックの非同期性によるものだった。あたりまえといえば当たり前。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246603195385704449"
            target="_blank">2020/4/5 9:58:57</a></p>
      </header>
      <section>
        <p class="tweet-text">sqlite3_exec()はJS側では以下のように呼び出す。<br/>await db.exec("select * from test;",(row)=&gt; {<br/>  console.log(row);<br/>});<br/><br/>２つ目の引数にコールバックを渡すと、そのクエリがデータを返すものであった場合行ごとにコールバックが呼ばれるように考えた。この</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246603799495491589"
            target="_blank">2020/4/5 10:01:21</a></p>
      </header>
      <section>
        <p class="tweet-text">このメソッドはPromiseも返すようになっていて、コールバックによって行データがすべて返されたときにresolve()するように考えた。が、実際はコールバックがすべて行情報を返却する前にresolve()されてしまっていた。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246605346002440192"
            target="_blank">2020/4/5 10:07:29</a></p>
      </header>
      <section>
        <p class="tweet-text">ThreadSafeFunctionを使いAsyncWorkerのExecute()からメインスレッド上で実行が必要な処理を行うようにした。Execute()内は別のスレッドで動いていて、node addon api関連の処理は行えないようになっているからである。逆にいうとそういうことをしたければThreadSafeFunctionを使えということ。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246606846128836609"
            target="_blank">2020/4/5 10:13:27</a></p>
      </header>
      <section>
        <p class="tweet-text">sqlite3_execのコールバックはAsyncWorkerのスレッドで実行されるから、そこで得られた行データをThreadSafeFunction::BlockingCall使って引数で指定するコールバックに渡す。コールバックはメインスレッドで実行されるので、node addon apiが使えるようになる。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246608834598068224"
            target="_blank">2020/4/5 10:21:21</a></p>
      </header>
      <section>
        <p class="tweet-text">このコールバックでデータをJSのオブジェクトに変換して、JS側のコールバックFunctionを呼び出すのである。でここで問題なのはThreadSafeFunction::BlockingCallもしくはコールバックが非同期で行われるということである。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246609411050627072"
            target="_blank">2020/4/5 10:23:39</a></p>
      </header>
      <section>
        <p class="tweet-text">ThreadSafeFunction::BlockingCallは名前からすると同期呼び出しのように思うけど、実際は呼び出すコールバックを格納するキューに空きがない場合は空くまで待たされるというだけのことである。キューに渡された後いつ処理されるかはわからない。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246609973347409921"
            target="_blank">2020/4/5 10:25:53</a></p>
      </header>
      <section>
        <p class="tweet-text">以下のメソッドのコールバック部分は非同期で行われる。これ自体は期待した動きであるが、問題なのはPromise::resolve()の実行タイミングがコールバックが非同期なために掴めないことである。<br/>await db.exec("select * from test;",(row)=&gt; {<br/>  console.log(row);<br/>  rows.push(row);<br/>});</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246610756956590082"
            target="_blank">2020/4/5 10:29:00</a></p>
      </header>
      <section>
        <p class="tweet-text">今の時点ではAsyncWorker::OnOk()でPromiseをresolve()するようにしてるけど、さっき書いた通りコールバック自体はメインスレッドのキューに渡すので、AsyncWorkerのOnOk()は実際にコールバック呼び出しが完了してしまう前に呼び出されてしまうのだった。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246612470778609664"
            target="_blank">2020/4/5 10:35:48</a></p>
      </header>
      <section>
        <p class="tweet-text">つまりAsyncWorkerからメインスレッドに委託した処理の終了を検知してPromiseをresolve()しないと所望の動きにならない。そこをどうするか今考えているところ。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246709778228764672"
            target="_blank">2020/4/5 17:02:28</a></p>
      </header>
      <section>
        <p class="tweet-text">このへんところどころスレッドやスレッド・コンテキストの話が出てくるが、「node.jsはシングル・スレッドなのになぜ？」と思う人もいるだろう。私もかつては（といってもほんの少し前だが）そう思っていた。が、node.jsは非同期処理（ノンブロッキングな処理）を実現するためにスレッドを活用してる。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246711938970554371"
            target="_blank">2020/4/5 17:11:03</a></p>
      </header>
      <section>
        <p class="tweet-text">node.jsはI/Oをほぼ非同期で行えるが、それはlibuvで実現している。libuvはファイルI/OはブロッキングI/Oを使っているけど、そこをノン・ブロッキングであたかも行えているように見せるためにワーカー・スレッドを使ってる。つまりnode.js自体はマルチ・スレッドで動いている。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246712403296952321"
            target="_blank">2020/4/5 17:12:54</a></p>
      </header>
      <section>
        <p class="tweet-text">node.jsは例外的にファイルI/Oは同期的に処理が行えるけどこれはこの仕組み（ブロッキングI/O＋スレッドでノン・ブロッキングI/Oを実現）のおかげであると思う。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246713791330451461"
            target="_blank">2020/4/5 17:18:25</a></p>
      </header>
      <section>
        <p class="tweet-text">昔Windows APIでオーバーラップI/OとかIOCPとかを使ったファイルI/Oの実装を試したことがあったが、あれとよく似た感じである。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246716300472119296"
            target="_blank">2020/4/5 17:28:23</a></p>
      </header>
      <section>
        <p class="tweet-text">まあ今回のトラブルはそういう高尚な話に関係しているのではなく私の設計および実装がへたくそすぎるだけだが（笑）</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246716606224334848"
            target="_blank">2020/4/5 17:29:36</a></p>
      </header>
      <section>
        <p class="tweet-text">実際sqlite3_execを呼び出しているコードは以下である。<br/>char* message = nullptr;<br/>int status = sqlite3_exec(<br/>  const_cast&lt;sqlite3*&gt;(db_.handle()),<br/>  const_cast&lt;char*&gt;(sqlStatement_.c_str()),<br/>  need_callback_ ? exec_callback : 0,<br/>  this,<br/>  &amp;message<br/>);</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246718038675603458"
            target="_blank">2020/4/5 17:35:17</a></p>
      </header>
      <section>
        <p class="tweet-text">このsqlite3_exec() は同期的にexec_callbackが呼び出される（need_callback_ がtrueであった場合）。もしsqlStatementが行データを返すのであれば全行分のコールバックがここで発生する。このAPIの完了=すべての行返却済みとなるはずである。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246718847115120640"
            target="_blank">2020/4/5 17:38:30</a></p>
      </header>
      <section>
        <p class="tweet-text">でこの処理自体はAsyncWorker::Execute()内で行っているので、Execute()を抜けるつまりAsyncWorker::OnOk()が呼び出された時点でPromise::resolve()すれば良い。エラーならOnError()でreject()すればよい。と最初思ってた。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246720314324578310"
            target="_blank">2020/4/5 17:44:20</a></p>
      </header>
      <section>
        <p class="tweet-text">が途中でsqlite3_exec()のコールバック中にあるJSへのコールバック（JSへの行データ返却）を非同期に変更したため、「AsyncWorker::Execute()の完了時点でJSへ行データをすべて返却している」前提が崩れてしまった。というのが問題のもう少し詳細な話。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246721117550571520"
            target="_blank">2020/4/5 17:47:32</a></p>
      </header>
      <section>
        <p class="tweet-text">少し前にAsyncWorkerではなくThreadSafeFunctionで置き換えるみたいなことを言っていたがこれは間違い。AsyncWorker内でもThreadSafeFunctionは使える。ThreadSafeFunctionはメインスレッド以外からメインスレッドのコンテキストでJS関数を呼び出す（C++関数も呼べる）ものなので。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246722299421548544"
            target="_blank">2020/4/5 17:52:13</a></p>
      </header>
      <section>
        <p class="tweet-text">ワーカー・スレッドからメイン・スレッドに対して非同期処理をお願いしてるので、ワーカー・スレッドがお願いした非同期処理の完了を検知できればこの問題は解決する。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246726118436028416"
            target="_blank">2020/4/5 18:07:24</a></p>
      </header>
      <section>
        <p class="tweet-text">流れは<br/><br/>１．メインがワーカーを起動し処理を委託<br/>２．ワーカーが処理してメインに非同期でコールバック<br/>３．ワーカーがメインへのコールバックが完了することを確認してメインにPromiseで完了を通知<br/>４．メインはPromiseで完了を受け取る<br/><br/>こうしたいところ。うまくいかんけど。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246744299636576256"
            target="_blank">2020/4/5 19:19:39</a></p>
      </header>
      <section>
        <p class="tweet-text">node-addon-apiはn-apiをすべて網羅しているわけではなさそう。解決の糸口を見つける意味でもn-apiも調べてみるか。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246898593446768640"
            target="_blank">2020/4/6 5:32:45</a></p>
      </header>
      <section>
        <p class="tweet-text">この辺をじっくり読もうと思っている。。<br/><blockquote class="card card-default"><header><div class="no-image" >No Image</div><a href="https://nodejs.org/api/n-api.html#n_api_asynchronous_thread_safe_function_calls" target="_blank">N-API | Node.js v14.8.0 Documentation</a></header><div></div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246917957076180992"
            target="_blank">2020/4/6 6:49:42</a></p>
      </header>
      <section>
        <p class="tweet-text">じっくり読んだが、 node-addon-apiのドキュメント以上のことは書いてなかった。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246918988560363522"
            target="_blank">2020/4/6 6:53:48</a></p>
      </header>
      <section>
        <p class="tweet-text">ただ気づいた点として、ThreadSafeFunctionはそれ自体でワーカースレッドをいくつか作るということだ。つまりAsyncWorkerを使うとそれ自体でスレッドが1つ、ThreadSafeFunctionで少なくとも一つ作られることになる。つまり最低でも3つのスレッドで協調動作させる必要があるということ。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246919839437844481"
            target="_blank">2020/4/6 6:57:11</a></p>
      </header>
      <section>
        <p class="tweet-text">ThreadSafeFunctionのワーカースレッドはメインスレッドのキューにワークを突っ込むために用いられると思われる。これはおそらくワーカースレッドのブロックを防ぐためだと推測する。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246922027241336832"
            target="_blank">2020/4/6 7:05:52</a></p>
      </header>
      <section>
        <p class="tweet-text">ThreadSafeFunctionはNew()でキューサイズとワーカースレッド数を指定する。それぞれに1を設定して、<br/>BlockingCallで呼び出すとAsyncWorkerのワーカースレッドとThreadSafeFunctionのワーカースレッドが協調して同期的にコールバックをメインスレッドのキューに送ることができる。がこれは、</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246922761462661120"
            target="_blank">2020/4/6 7:08:47</a></p>
      </header>
      <section>
        <p class="tweet-text">あくまでメインスレッドのキューに送るとこまでを同期的に行うだけで、メインスレッドでいつコールバックが行われるかわからない。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246923232587829248"
            target="_blank">2020/4/6 7:10:40</a></p>
      </header>
      <section>
        <p class="tweet-text">Windows APIでいうところのPostMessageではなくSendMessageみたいな処理がしたいところ。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246924551432224768"
            target="_blank">2020/4/6 7:15:54</a></p>
      </header>
      <section>
        <p class="tweet-text">でThreadSafeFunctionでワーカースレッド使われるのならAsyncWorkerいらないんじゃない？と思ったが、このワーカースレッドは自前処理を走らせることはできないんだな、これが。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246924650925281281"
            target="_blank">2020/4/6 7:16:18</a></p>
      </header>
      <section>
        <p class="tweet-text">コールバックを呼び出すことだけ。基本は。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247098692655386626"
            target="_blank">2020/4/6 18:47:52</a></p>
      </header>
      <section>
        <p class="tweet-text">まだ完成には程遠いが、ここまでのC++側のコードはこんな感じ。。<br/><br/><blockquote class="card card-large"><header><img  src="https://github.githubassets.com/images/modules/gists/gist-og-image.png" /><a href="https://gist.github.com/sfpgmr/0b46e809348c8e5d59cc334f129269e7" target="_blank">sqlite3-napi.cc · GitHub</a></header><div>GitHub Gist: instantly share code, notes, and snippets.</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247099057442443265"
            target="_blank">2020/4/6 18:49:19</a></p>
      </header>
      <section>
        <p class="tweet-text">Statementにはまだまったく手を付けていない。「sqlite3_execをなんとか行ごとに非同期コールバックでデータを返却したい」問題で停滞しているので。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247099391636168705"
            target="_blank">2020/4/6 18:50:39</a></p>
      </header>
      <section>
        <p class="tweet-text">いったんsqlite3_execが返す行データを、いったんAsyncWorkerでキャッシュしてメイン・スレッドに返すという手もあるけど中間で消費するメモリがなあ。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247123656989216769"
            target="_blank">2020/4/6 20:27:04</a></p>
      </header>
      <section>
        <p class="tweet-text">ちょっとsqlite3_exec()のソースコードを読んでいた。コールバック<br/>int(*callback)(void*,int,char** values,char** columnNames)でセットされるvaluesとcolumnNamesのメモリって解放しなくていいの？というのとライフタイムはどうなってるの？というところが疑問だったので。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247125530811363328"
            target="_blank">2020/4/6 20:34:31</a></p>
      </header>
      <section>
        <p class="tweet-text">結論からいうと、<br/>valuesやcolumnNamesの中身は放っておいてよい。sqlite3側で自動的に開放されるようだ。ライフタイムはコールバック終了までと考えておいたほうがよさそうだ。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247125991660507141"
            target="_blank">2020/4/6 20:36:21</a></p>
      </header>
      <section>
        <p class="tweet-text">今抱えている問題はまだ方向性を見いだせていない。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247126970191605760"
            target="_blank">2020/4/6 20:40:14</a></p>
      </header>
      <section>
        <p class="tweet-text">ちなみにsqlite3_exec()はスレッド・セーフであった。処理はmutexで排他制御されてるね。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247127083479789568"
            target="_blank">2020/4/6 20:40:41</a></p>
      </header>
      <section>
        <p class="tweet-text">sqlite3はマルチスレッド・サポートされてるから当然か。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247127489685540865"
            target="_blank">2020/4/6 20:42:18</a></p>
      </header>
      <section>
        <p class="tweet-text">しかしこうなるとコールバックされてる間は確実に同期的に処理されるので、これをあえて非同期に分解する意味はあるのだろうかと思ったりする。おそらくないだろうな（笑）。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247288146389164032"
            target="_blank">2020/4/7 7:20:42</a></p>
      </header>
      <section>
        <p class="tweet-text">まだちょっと完全ではないが、Promise::Deferred::resolve()の動作タイミングをsqlite3_exec()のコールバック完了後に持ってくることができた。今ちょっとメモリのマネジメントにむずかしさを感じているところ。C++ならではの話。ガベコレがある言語では不要な思考。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247289223348027392"
            target="_blank">2020/4/7 7:24:59</a></p>
      </header>
      <section>
        <p class="tweet-text">JSでこういうコードを書く。そして実行すると<br/><br/>await <a href="http://db.open" target="_blank">db.open</a>("./test.db");<br/>await db.exec("select * from test;",(row)=&gt; {<br/>  rows.push(row);<br/>});<br/><blockquote class="card card-default"><header><div class="no-image" >No Image</div><a href="http://console.info" target="_blank">Console.info domain is for sale | Buy with Epik.com</a></header><div></div></blockquote>(rows);<br/>rows.forEach(element =&gt; {<br/>  <blockquote class="card card-default"><header><div class="no-image" >No Image</div><a href="http://console.info" target="_blank">Console.info domain is for sale | Buy with Epik.com</a></header><div></div></blockquote>(element);<br/>});<br/>await db.close();</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247289633538334720"
            target="_blank">2020/4/7 7:26:36</a></p>
      </header>
      <section>
        <p class="tweet-text">出力結果はこうなって、最後に「Segmentation fault」がでる。<br/>[<br/>  { a: 'aaaa', b: 'aa' },<br/>  { a: 'bbbb', b: 'bb' },<br/>  { a: 'cccc', b: 'cc' }<br/>]<br/>{ a: 'aaaa', b: 'aa' }<br/>{ a: 'bbbb', b: 'bb' }<br/>{ a: 'cccc', b: 'cc' }<br/>Segmentation fault</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247289961692327936"
            target="_blank">2020/4/7 7:27:55</a></p>
      </header>
      <section>
        <p class="tweet-text">db.execはコールバック呼び出しが終わるまでawaitできるようになった。がなぜかSegmentation faultが出てしまう。おそらく何らかの凡ミスであるとは思うのだが。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247290194769764352"
            target="_blank">2020/4/7 7:28:50</a></p>
      </header>
      <section>
        <p class="tweet-text">ちなみにsqlite3_exec()で返る行データはオブジェクトで返すようにしてみている。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247311327145541633"
            target="_blank">2020/4/7 8:52:48</a></p>
      </header>
      <section>
        <p class="tweet-text">vs code でnode native addonをデバッグする方法がわかったので、今後はそれ使ってseg faultの原因を究明することにした。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247311462512484355"
            target="_blank">2020/4/7 8:53:21</a></p>
      </header>
      <section>
        <p class="tweet-text">おそらくメモリ管理あたりの凡ミスだと思うけどね。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247326782228795393"
            target="_blank">2020/4/7 9:54:13</a></p>
      </header>
      <section>
        <p class="tweet-text">vs code にアドオンを入れてlaunch.jsonを書くだけで済んだ。<br/><br/><blockquote class="card card-large"><header><img  src="https://miro.medium.com/max/490/0*8WYXGmOEpIl89da5.jpg" /><a href="https://medium.com/@atulanand94/debugging-nodejs-c-addons-using-vs-code-27e9940fc3ad" target="_blank">🐞 Debugging NodeJS C++ addons using VS Code | by Atul | Medium</a></header><div>I believe that programming in a new language or domain seems hard until you know how to debug properly.</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247327250858545158"
            target="_blank">2020/4/7 9:56:05</a></p>
      </header>
      <section>
        <p class="tweet-text">まあvs codeもエディタの域を超えて、IDEと言っても差し支えないような感じになってるなあ。。本家のvsは使わなくなって数年経つが、どうなってんだろうな。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247626214186971136"
            target="_blank">2020/4/8 5:44:03</a></p>
      </header>
      <section>
        <p class="tweet-text">lldbでデバッグした結果、やはり凡ミスだった。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247627969742299136"
            target="_blank">2020/4/8 5:51:02</a></p>
      </header>
      <section>
        <p class="tweet-text">複数のクエリもちゃんと返ってくる！！<br/>await db.exec("select * from test;select * from test2;",(r)=&gt;{<br/>     rows.push(r);<br/>}); https://t.co/f5BbL31tQ4</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/EVB2zmvU8AAxA1t.png" />
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248006585449730049"
            target="_blank">2020/4/9 6:55:31</a></p>
      </header>
      <section>
        <p class="tweet-text">今はsqlite3_load_extension()とsqlite3_config()のwrapperを書いているところ。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248379143089057792"
            target="_blank">2020/4/10 7:35:56</a></p>
      </header>
      <section>
        <p class="tweet-text">ちょっとここに来てラッパーのベースとなるライブラリをsqlcipherからsqlite3にいったん戻そう。暗号化については別途考えることにする。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248415875658469379"
            target="_blank">2020/4/10 10:01:53</a></p>
      </header>
      <section>
        <p class="tweet-text">とりあえずDatabaseに関する実装は終わり、ベースのライブラリをsqlite3に変更した。続いてStatementの実装をしようと思う。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248503752539029504"
            target="_blank">2020/4/10 15:51:05</a></p>
      </header>
      <section>
        <p class="tweet-text">Statementの実装をしていると同期メソッドも用意しておいたほうがいいなあと思ってくる。もともとのsqlite3のAPIがビジー状態を防ぐような作りになってる気がするんだな。SQL発行→行取得までの処理が分割されてAPIとして提供されているところとかね。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248505047907876869"
            target="_blank">2020/4/10 15:56:14</a></p>
      </header>
      <section>
        <p class="tweet-text">非同期コールバックをワーカースレッドでやるというのはそれ自体かなりオーバーヘッドがある。sqlite3のAPIがあのようなつくりなのでメインスレッドをさほど占有しない気がして、ワーカーに預ける意味ってあまりないんじゃないかなと思ったりする。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248507065544265728"
            target="_blank">2020/4/10 16:04:15</a></p>
      </header>
      <section>
        <p class="tweet-text">まあしかしjsからのメソッド呼び出しが都度イベントループに突っ込まれるかというと、そうでもないよな。とするとこの考えは少しおかしいかな・・。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248507782480846849"
            target="_blank">2020/4/10 16:07:06</a></p>
      </header>
      <section>
        <p class="tweet-text">ThreadSafeFunctionを使ってコールバックするという手もあるよな。これだとコールバックのたびにメインのイベントループに突っ込まれるもんな。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248508092792197120"
            target="_blank">2020/4/10 16:08:20</a></p>
      </header>
      <section>
        <p class="tweet-text">このあたりもうちょっとv8やlibuvのことがわからんとはっきりしないよなあ。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248581962387746816"
            target="_blank">2020/4/10 21:01:52</a></p>
      </header>
      <section>
        <p class="tweet-text">Statementは結局同期・非同期両方のメソッドを用意することにした。ただいま実装中。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248753589465444352"
            target="_blank">2020/4/11 8:23:51</a></p>
      </header>
      <section>
        <p class="tweet-text">sqlite3_bind_xxの実装をしているところで、このIssueに引っかかった。。<br/><br/><blockquote class="card card-default"><header><img  src="https://avatars1.githubusercontent.com/u/9950313?s=400&v=4" /><a href="https://github.com/nodejs/node-addon-api/issues/57" target="_blank">More special types check · Issue #57 · nodejs/node-addon-api · GitHub</a></header><div>node-sqlite3 uses val.IsDate(), val.IsRegExp(), val.IsInt32(). I think we need to think about how to support these.</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248753891644076032"
            target="_blank">2020/4/11 8:25:03</a></p>
      </header>
      <section>
        <p class="tweet-text">まずnode-sqlite3をN-APIもしくはnode-addon-apiでリライトしようという人たちがいるということがわかったね。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248755356773187584"
            target="_blank">2020/4/11 8:30:52</a></p>
      </header>
      <section>
        <p class="tweet-text">Napi::Valueで整数か実数かを判定するメソッドがないという問題。IsInt32()があればいいんだけどね。なぜかない。node-sqlite3ではv8のValueを使っているんでIsInt32()が使える。型判定メソッドはv8のValueの方が豊富である。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248756897148063747"
            target="_blank">2020/4/11 8:36:59</a></p>
      </header>
      <section>
        <p class="tweet-text">たしかJSはDoubleの仮数部56ビットのうち、32ビット分を使って整数値を格納しているはずなんだな。なのでいったんDoubleに変換した後でビットベースでチェックすれば整数だとわかるはず。。これはECMAScriptの規格だからJSのエンジンによる実装の違いはないと思う。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248757244230914051"
            target="_blank">2020/4/11 8:38:22</a></p>
      </header>
      <section>
        <p class="tweet-text">V8のIsInt32の実装を見てみればいいんだな。あとはエンディアンか。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248764526712913920"
            target="_blank">2020/4/11 9:07:18</a></p>
      </header>
      <section>
        <p class="tweet-text">node-sqlite3でも議論されてるよね。<br/><blockquote class="card card-default"><header><img  src="https://avatars2.githubusercontent.com/u/600935?s=400&v=4" /><a href="https://github.com/mapbox/node-sqlite3/issues/830" target="_blank">N-API Support for node-sqlite3 · Issue #830 · mapbox/node-sqlite3 · GitHub</a></header><div>The recently announced Node 8 has a new experimental feature called N-API which is aimed at reducing maintenance cost for node native addons. Checkout this blog for more details on its benefits. Mo...</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248766163959439360"
            target="_blank">2020/4/11 9:13:49</a></p>
      </header>
      <section>
        <p class="tweet-text">私が作成中のものはsqlite3のAPIに寄せようと思っていて、node-sqlite3のrun/get/eachとかはどうしようかなと思っている。この部分が一番asyncが使えるところだから実装すべきなんだけどね。今ではasync functionがJSで使え、ループで代替できるから、実装する必要性がさほどないような気もしている。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248766619351826432"
            target="_blank">2020/4/11 9:15:37</a></p>
      </header>
      <section>
        <p class="tweet-text">あ、さっきの56ビットじゃなくて53ビットだった。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248769830590636033"
            target="_blank">2020/4/11 9:28:23</a></p>
      </header>
      <section>
        <p class="tweet-text">V8のソースをgit cloneしてIsInt32()の実装を読んでみることにする。なんかネット上のソースを見た感じではやっぱりビットパターンで整数値かどうかの判定をしてそうなのだが、もうちょっとちゃんとチェックしたいので。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248770814859546624"
            target="_blank">2020/4/11 9:32:17</a></p>
      </header>
      <section>
        <p class="tweet-text">IsInt32()の実装はこれ。IsSmi()がtrueもしくはIsInt32Double()がtrueであればInt32であるということがわかるのですな。じゃあそれを読もう。 https://t.co/bDQLFP1Mv9</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/EVSGKYvUUAAPWNI.png" />
        
      </section>
      
    </article>
    
    <article>
      
      
      <header class="tweet-header">
        
        <img class="tweet-profile-img"  src="https://pbs.twimg.com/profile_images/1231176331628433408/1rqOW5xD_normal.jpg" />
        <p class="tweet-user-name">κeen@blackenedgold</p>
        
        <p class="tweet-date"><a href="https://twitter.com/blackenedgold/status/1247172631880589317"
            target="_blank">2020/4/6 23:41:41</a></p>
      </header>
      <section>
        <p class="tweet-text">かなり本格的にインタプリタを作る記事らしい。目次眺めた感じ、VM作ってるしGCも書いてるしclassもあるしNaN boxingとかもしてるし、ここまで充実した資料ほとんどないよね。<br/><br/>Crafting Interpreters<br/><a href="http://craftinginterpreters.com/" target="_blank">craftinginterpreters.com</a></p>
        
      </section>
      
    </article>
    
    <article>
      
      
      <header class="tweet-header">
        
        <img class="tweet-profile-img"  src="https://pbs.twimg.com/profile_images/1212701145379946496/pSDVrvWj_normal.png" />
        <p class="tweet-user-name">S.F.@SFPGMR</p>
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247328008559415296"
            target="_blank">2020/4/7 9:59:06</a></p>
      </header>
      <section>
        <p class="tweet-text">時差出勤してるが今日は昨日に比べてガラガラだなあ、電車。ちなみに明日はテレワーク。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247328374919327744"
            target="_blank">2020/4/7 10:00:33</a></p>
      </header>
      <section>
        <p class="tweet-text">いつもこれくらいだと嬉しいけどね。。コロナで労働環境が良くなってるという、なんとも皮肉な現実だわ。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247328967331213318"
            target="_blank">2020/4/7 10:02:54</a></p>
      </header>
      <section>
        <p class="tweet-text">多分リモートワークで生産性を高め、成果を出すような仕事の仕方を普段からしとけばこういうリスクにも強いよな。。</p>
        
      </section>
      
    </article>
    
    <article>
      
      
      <header class="tweet-header">
        
        <img class="tweet-profile-img"  src="https://pbs.twimg.com/profile_images/617722474327732224/kEGNMW1w_normal.png" />
        <p class="tweet-user-name">b.p.s.@BasicProgrammer</p>
        
        <p class="tweet-date"><a href="https://twitter.com/BasicProgrammer/status/1246108439463333888"
            target="_blank">2020/4/4 1:12:58</a></p>
      </header>
      <section>
        <p class="tweet-text">BASICで３DCG、MSX turboRでもやってみました。<br/>88版ほぼそのまま動きました(^^)<br/>TIMEは36063だったので、10分1秒でした。 <a href="https://twitter.com/Stosstruppe/status/1245682316325740545" target="_blank">twitter.com/Stosstruppe/st…</a> https://t.co/OwK4VIWFux</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/EUsOI9uU8AAWw9i.png" />
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/EUsOyPlU4AEy45P.png" />
        
      </section>
      
    </article>
    
  </div>
  <footer>
    CopyLight 2019 Satoshi Fujiwara
  </footer>
  <script async src="https://platform.twitter.com/widgets.js"></script>

  <script async src="./index.js"></script>

</body>

</html>