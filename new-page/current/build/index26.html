<!DOCTYPE html>

<html lang="ja" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-15457703-9"></script>
  <script>
    if (!location.hostname.match(/localhost/)) {
      window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      gtag('js', new Date());
      gtag('config', 'UA-15457703-9');
    }
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Twitter Viewer</title>
  <meta name="description" content="自作Twitter Viewerによる自分のつぶやきの記録。Programming,Music,HTML5,WebGL,javascript,WebAudio,Gameなど" />
  <meta name="keywords" content="Programming,Music,HTML5,WebGL,javascript,WebAudio" /> 	

  <meta itemprop="image" content="https://www.sfpgmr.net/img/sfweb.png" />
  <meta itemprop="name" content="S.F. Web" />
  
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="S.F. Web" />
  <meta name="twitter:url" content="./index26.html" />
  <meta name="twitter:title" content="Twitter Viewer" />
  <meta name="twitter:description" content="自作Twitter Viewerによる自分のつぶやきの記録。Programming,Music,HTML5,WebGL,javascript,WebAudio,Gameなど" />
  <meta name="twitter:image" content="https://www.sfpgmr.net/img/sfweb.png" />
  
  <meta property="og:type" content="article">
  <meta property="og:url" content="./index26.html" />
  <meta property="og:title" content="Twitter Viewer"/>
  <meta property="og:site_name" content="S.F. Web" />
  <meta property="og:description" content="Programming,Music,HTML5,WebGL,javascript,WebAudio">
  <meta property="og:image" content="https://www.sfpgmr.net/img/sfweb.png">

  <style>
  * {
  margin: 0;
  padding: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

html {
  margin: 0;
  padding: 0;
  font-size: 10px; }

body {
  margin: 0;
  padding-left: 8px;
  padding-right: 8px;
  background: black;
  color: white; }

.top-nav {
  position: fixed;
  z-index: 99999;
  background: rgba(0, 0, 0, 0.5);
  display: block;
  width: 100%;
  height: 32px;
  color: white; }

#sentinel {
  width: 0px;
  height: 0px; }

.contents {
  padding-top: 32px;
  width: 100%;
  position: relative;
  content: strict; }

@keyframes blinking {
  0% {
    color: black; }
  50% {
    color: white; }
  100% {
    color: black; } }

.loading {
  font-family: monospace;
  font-size: 24px;
  position: fixed;
  width: 100vw;
  height: 100vh;
  text-align: center;
  padding-top: 50vh;
  z-index: 32768;
  background: black;
  animation: blinking 2s infinite;
  content: strict; }

.contents > article {
  background: #f0f0f0;
  color: #202020;
  position: absolute;
  max-height: 960px;
  overflow: auto;
  border-radius: 3px;
  /* transition: opacity 1s linear;*/
  opacity: 1.0; }

.tweet-header {
  display: grid;
  align-items: end;
  grid-template-columns: 40px 2fr 1fr;
  grid-template-rows: 1fr;
  font-size: 12px;
  font-weight: bold; }

.tweet-img {
  width: 100%;
  object-fit: cover; }

.youtube {
  position: relative;
  cursor: pointer; }

.youtube > img {
  width: 100%;
  object-fit: cover; }

.youtube > svg.player-play {
  width: 64px;
  height: 64px;
  left: calc(50% - 32px);
  top: calc(50% - 32px);
  position: absolute;
  z-index: 1000;
  opacity: 0.5; }

.youtube:hover > svg.player-play {
  opacity: 1.0; }

.youtube:hover .player-play-1 {
  stroke: #80808080; }

.youtube > div.yt-title {
  /*text-shadow: #fff 1px 1px 0;*/
  font-size: 1.2rem;
  color: white;
  background: rgba(0, 0, 0, 0.5);
  position: absolute;
  left: 0;
  top: 0;
  overflow: auto;
  z-index: 998; }

.tweet-profile-img {
  grid-column: 1/2;
  width: 32px;
  height: 32px;
  border-radius: 50%; }

.tweet-user-name {
  grid-column: 2/3; }

.tweet-date {
  font-size: 8px;
  text-align: right;
  grid-column: 3/4; }

.contents > twitter-widget {
  overflow: auto;
  max-height: 960px;
  position: absolute; }

.contents > article > section > .tweet-text {
  display: block;
  padding: 4px;
  word-break: break-all;
  font-size: 12px; }

.contents > article > h3 {
  font-size: 12px; }

blockquote.card {
  margin: 4px;
  padding: 4px;
  font-size: 12px;
  background: white;
  border-radius: 4px; }

blockquote.card > header {
  display: grid;
  grid-gap: 4px;
  gap: 4px; }

blockquote.card-default > header {
  grid-template-columns: 64px 1fr; }

blockquote.card-large > header {
  grid-template-columns: 1fr; }

blockquote.card > header > img {
  width: 100%; }

div.no-image {
  display: block;
  width: 64px;
  height: 64px;
  background: gray;
  color: white;
  text-align: center;
  line-height: 64px; }
 
  </style>
</head>

<body>
  <div class="loading" id="loading">Loading</div>
  <header class="top-nav">
    <h1>S.F. Info.</h1>
  </header>
  <div class="contents" id="contents" rendersubtree="invisible skip-activation"> 
    
    
    <article>
      
      
      <header class="tweet-header">
        
        <img class="tweet-profile-img"  src="https://pbs.twimg.com/profile_images/1212701145379946496/pSDVrvWj_normal.png" />
        <p class="tweet-user-name">S.F.@SFPGMR</p>
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244045709982101504"
            target="_blank">2020/3/29 8:36:25</a></p>
      </header>
      <section>
        <p class="tweet-text">今ちょっとsqlite3のnodeバインディングである「node-sqlite3」の「node-sqlcipher」をいじって、Promiseベースのインターフェースへの書き換えを試みようとして、いろいろ調べているところである。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244046323533246464"
            target="_blank">2020/3/29 8:38:51</a></p>
      </header>
      <section>
        <p class="tweet-text">sqlcipherはsqlite3のデータを暗号化することができる以外はsqlite3と同じである。そしてnode-sqlcipherはnode-sqlite3とはバインディング先のモジュールが「sqlite3」なのか、「sqlcipher」なのかの違いだけで、JSから見たAPIは同じものである。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244047077669081088"
            target="_blank">2020/3/29 8:41:51</a></p>
      </header>
      <section>
        <p class="tweet-text">sqlite3はロック粒度が「ファイル単位」であり、ローカルのアプリ（主に1人で使うもの）に向いている。サーバー側の認証情報を持っておくような用途には向いていない。が、扱いが簡単で同時実行制御機能もなくはないので小規模なものなら運用できそうではある。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244047959286632449"
            target="_blank">2020/3/29 8:45:21</a></p>
      </header>
      <section>
        <p class="tweet-text">sqlite3に行レベルのロックを設ければロック競合の問題がある程度回避できるので、そのような実装を行った例もあるようだ。<br/><a href="https://www.ieice.org/publications/conference-FIT-DVDs/FIT2018/data/pdf/D-016.pdf" target="_blank">ieice.org/publications/c…</a></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244048737191649280"
            target="_blank">2020/3/29 8:48:26</a></p>
      </header>
      <section>
        <p class="tweet-text">それはさておき、Native Addonを作るには？だけどこれはなかなか大変である。私のようなド素人にとっては。環境自体どう作ったらよいかわからない。しかもnodeは複数のOSで動かすから、それぞれのOSでコンパイルできるようにしないといけない。しかしそのような環境は私にはない。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244049223185600513"
            target="_blank">2020/3/29 8:50:22</a></p>
      </header>
      <section>
        <p class="tweet-text">かろうじてwsl2とWindows 10はあるのでlinux/windows に関してはコンパイルして試すということができそうだが。しかしnode.jsで遊ぶ限りlinux(wsl2)の居心地が良すぎてここ1－2年はwindowsのバイナリでnodeアプリケーションを動かしてない。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244049574072733696"
            target="_blank">2020/3/29 8:51:46</a></p>
      </header>
      <section>
        <p class="tweet-text">私のようなレベルでも路頭に迷わないようにいろいろなものが用意されているのだが、いろいろありすぎてわけがわからない。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244050144292507649"
            target="_blank">2020/3/29 8:54:02</a></p>
      </header>
      <section>
        <p class="tweet-text">まずはnodeにはnode-gypが用意されていて、これを使うことによってOS間のビルド環境の差を吸収してくれるようである。そういうものがあるというのは知ってはいるがあくまでモジュールのインストールで言葉として出てくるだけで内容はほとんど知らないに等しい。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244051463438917632"
            target="_blank">2020/3/29 8:59:16</a></p>
      </header>
      <section>
        <p class="tweet-text">node-gypというのはgypのnodeバインディングということである。gypといのはGenerate Your Projectの略である。もともとchromiumのビルドを行うために作られたものらしい。ただchromiumはgypからgnというのに移行したらしいが。nodeはgypを使い続けるらしい。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244052294456377344"
            target="_blank">2020/3/29 9:02:35</a></p>
      </header>
      <section>
        <p class="tweet-text">gypというのはクロスプラットフォーム・ビルドシステムでmakeやcmakeとかの類かなと思ってたんだけど、違った。gypは「メタ・ビルドシステム」とのこと。つまり<br/>メタ・ビルドスクリプトを書いて、複数のビルド・システムのビルドスクリプトを生成するツールなのだった。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244052574161866752"
            target="_blank">2020/3/29 9:03:41</a></p>
      </header>
      <section>
        <p class="tweet-text">gypで書いたスクリプトはmakeやcmake、nmakeがそれぞれ解釈できるスクリプトに翻訳されるわけですな。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244053391321346049"
            target="_blank">2020/3/29 9:06:56</a></p>
      </header>
      <section>
        <p class="tweet-text">つまりnodeのNative Addon開発者は<br/>1. gypでビルドスクリプトを書く<br/>2. 対応するビルドシステムのビルドスクリプトを出力<br/>3. 対応するビルドシステムでビルド<br/><br/>とこういうステップでビルドを進めないといけないわけですな。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244070471093465089"
            target="_blank">2020/3/29 10:14:48</a></p>
      </header>
      <section>
        <p class="tweet-text">でnode-gyp使ってHello World的なNative Addonを作ってみる。<br/><blockquote class="card card-default"><header><img  src="https://avatars1.githubusercontent.com/u/9950313?s=400&v=4" /><a href="https://github.com/nodejs/node-gyp" target="_blank">GitHub - nodejs/node-gyp: Node.js native addon build tool</a></header><div>Node.js native addon build tool. Contribute to nodejs/node-gyp development by creating an account on GitHub.</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244071854601465856"
            target="_blank">2020/3/29 10:20:18</a></p>
      </header>
      <section>
        <p class="tweet-text">mkdir na<br/>cd na<br/>npm init<br/><br/>はまあいつもの感じですわな。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244072960752668672"
            target="_blank">2020/3/29 10:24:42</a></p>
      </header>
      <section>
        <p class="tweet-text">そして<br/><br/>npm i node-gyp<br/><br/>を入れると。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244073142068236288"
            target="_blank">2020/3/29 10:25:25</a></p>
      </header>
      <section>
        <p class="tweet-text">そしてbinding.gypファイルを作る。<br/><br/><blockquote class="card card-default"><header><img  src="https://avatars1.githubusercontent.com/u/9950313?s=400&v=4" /><a href="https://github.com/nodejs/node-gyp#the-bindinggyp-file" target="_blank">GitHub - nodejs/node-gyp: Node.js native addon build tool</a></header><div>Node.js native addon build tool. Contribute to nodejs/node-gyp development by creating an account on GitHub.</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244169506441715713"
            target="_blank">2020/3/29 16:48:20</a></p>
      </header>
      <section>
        <p class="tweet-text">Native Addonを作る方法はいくつかあるようだ。<br/><br/>1.  v8とlibuvのAPIで頑張る<br/>2. nanを使う<br/>3. N-APIを使う<br/>4. node-addon-apiを使う</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244172766581907456"
            target="_blank">2020/3/29 17:01:17</a></p>
      </header>
      <section>
        <p class="tweet-text">■V8のAPIを直接叩くとV8の頻繁な変更に対応するのが大変→抽象化して再コンパイルだけで対応できることを目指したものがnan<br/>■jsのエンジンの差し替え等も考慮したより抽象度の高いABIを持つものがN-API。そしてそれをC++でラップしたのがnode-addon-api<br/><br/>ということのようだ。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244173798548451328"
            target="_blank">2020/3/29 17:05:23</a></p>
      </header>
      <section>
        <p class="tweet-text">この辺ちょっと理解が進んだ。確かにN-APIはサンプルコード読んでもv8::とか出てこんもんな。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244174651795767297"
            target="_blank">2020/3/29 17:08:47</a></p>
      </header>
      <section>
        <p class="tweet-text">node-addon-apiを使ったサンプルコードのコンパイル・実行は比較的簡単であった。<br/><br/>npm init<br/><br/>npm i node-gyp<br/>npm i bindings<br/>npm i node-addon-api<br/><br/>を入れ、binding.gypを書くだけでよかった。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244175045846425601"
            target="_blank">2020/3/29 17:10:21</a></p>
      </header>
      <section>
        <p class="tweet-text">いちからだとpythonやgccとかのインストールがいるんだろうけど、npmでモジュールを入れてnodeを使っている時点でその辺はクリアできているので必要なかった。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244175306644021253"
            target="_blank">2020/3/29 17:11:23</a></p>
      </header>
      <section>
        <p class="tweet-text">binding.gypの中身はこんな感じ。include_dirsの中身はさっぱりわからんが。<br/>{<br/>  "targets": [<br/>    {<br/>      "target_name": "na",<br/>      "include_dirs": ["&lt;!@(node -p \"require('node-addon-api').include\")"],<br/>      "sources": [ "src/na.cc" ]<br/>    }<br/>  ]<br/>}</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244175495643553792"
            target="_blank">2020/3/29 17:12:08</a></p>
      </header>
      <section>
        <p class="tweet-text">そして<blockquote class="card card-default"><header><div class="no-image" >No Image</div><a href="http://na.cc" target="_blank">news aktuell macht Ihre Kommunikation erfolgreicher</a></header><div></div></blockquote>にコードを書いてnpm i するだけでモジュールができた。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244175688015331330"
            target="_blank">2020/3/29 17:12:54</a></p>
      </header>
      <section>
        <p class="tweet-text">js側のコードはこんな感じ。<br/><br/>import binding from 'bindings';<br/>const addon = binding('na');<br/>console.log(<a href="http://addon.na" target="_blank">addon.na</a>()); // 'world'</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244176032891949056"
            target="_blank">2020/3/29 17:14:16</a></p>
      </header>
      <section>
        <p class="tweet-text"><blockquote class="card card-default"><header><div class="no-image" >No Image</div><a href="http://na.cc" target="_blank">news aktuell macht Ihre Kommunikation erfolgreicher</a></header><div></div></blockquote>はnode-addon-apiのまんま。。メソッドの名前を変えただけですわ。。 https://t.co/jDLTbhVqWf</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/EUQzUa6UcAE8POg.png" />
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244180592188485633"
            target="_blank">2020/3/29 17:32:23</a></p>
      </header>
      <section>
        <p class="tweet-text">まあここまでは誰でもできますわなあ。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244189837223014401"
            target="_blank">2020/3/29 18:09:07</a></p>
      </header>
      <section>
        <p class="tweet-text">VSCodeのsettings.jsonでC_Cpp.default.includePathにnapi.h関連のヘッダが通るように設定したらintellisenseも効くな。。 https://t.co/sZGEcYSCEl</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/EUQ_gyQU4AM4AT1.png" />
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244189908719136768"
            target="_blank">2020/3/29 18:09:24</a></p>
      </header>
      <section>
        <p class="tweet-text">なんかすげえ。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244204645691445248"
            target="_blank">2020/3/29 19:07:58</a></p>
      </header>
      <section>
        <p class="tweet-text">スーパーナチュラル観ながら合間にコード書いてるので全然進まん。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244205943224598528"
            target="_blank">2020/3/29 19:13:07</a></p>
      </header>
      <section>
        <p class="tweet-text">gypの書き方も覚えんといかんな。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244208837709590528"
            target="_blank">2020/3/29 19:24:37</a></p>
      </header>
      <section>
        <p class="tweet-text">node-sqlcipher/sqlite3はdepsディレクトリに本体のtarファイルが入っていて、これをextract.piで解凍してビルドしてるんだよな。でそれをgypでビルドするために<br/><br/>・common-sqlite.gypi<br/>・sqlite3.gyp<br/><br/>の2つのファイルがあるようだ。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244210332978917377"
            target="_blank">2020/3/29 19:30:34</a></p>
      </header>
      <section>
        <p class="tweet-text">いや違うな。sqlite3.gypの中で<a href="http://extract.py" target="_blank">extract.py</a>を呼び出してtarファイルを解凍してるわ。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244210516819492867"
            target="_blank">2020/3/29 19:31:18</a></p>
      </header>
      <section>
        <p class="tweet-text">gypの前にmakeを勉強していたので、中身はなんとなくわからんでもない。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244211350659674112"
            target="_blank">2020/3/29 19:34:36</a></p>
      </header>
      <section>
        <p class="tweet-text">ちなみにnode-sqlite3/sqlcipherはnanで作られてる。これをちょっとn-apiに書き換えてみようかなあと思うんだよね。。ハードルはかなり高いけどね。その時にpromiseベースに改造しようかなと。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244394122779090944"
            target="_blank">2020/3/30 7:40:53</a></p>
      </header>
      <section>
        <p class="tweet-text">今朝nanベースのsqlcipherバインディングであるnode-sqlcipherのコードを読み直している。N-APIに比べるとやはりnanはかなり薄いラッパーであることがわかる。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244396257348476928"
            target="_blank">2020/3/30 7:49:22</a></p>
      </header>
      <section>
        <p class="tweet-text">N-APIのリファレンスを見る限りv8やlibuvへのAPIに対する作業はほぼ内部的に処理され隠ぺいされている。ただしnode-sqlcipherはdbへの同期・非同期処理を実現するために独自のqueueを内部に持ち、非同期処理はuv_work_queue()を使って行っているからlibuvを直接いじるコードはそのまま残りそうだ。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244397018966921216"
            target="_blank">2020/3/30 7:52:23</a></p>
      </header>
      <section>
        <p class="tweet-text">dbへの作業をすべてpromiseベースにし、実行に関するスケジューリングはpromise/asyncで行う（つまりJS側でスケジューリングする）ようにすると内部的なスケジューラはいらなくなるのかもしれない。もうちょっとコードを深く理解しないと確定的なことはいえないが。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244397930213072896"
            target="_blank">2020/3/30 7:56:01</a></p>
      </header>
      <section>
        <p class="tweet-text">それのメリットとしてはlibuvに依存するコードがアドオンからなくなるのでポータビリティがより高まるということなんだけどね。内部的なスケジューリングはひょっとすると他の方法（例えばN-APIが持つ非同期の機能やスレッディング機能）で実現できるのかもしれんが、今はよくわからない。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244398870672494592"
            target="_blank">2020/3/30 7:59:45</a></p>
      </header>
      <section>
        <p class="tweet-text">しばらくはコードやAPIのドキュメントを読む日が続きますな。しかし思いのほかビルドまでのステップが簡単で済んでよかった。私のような趣味レベルだと、その環境整備だけでおなか一杯になってそのあと放置してしまうこと多々あるので。過去にそのような残骸が十数個くらいあると思う。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244399878400172032"
            target="_blank">2020/3/30 8:03:45</a></p>
      </header>
      <section>
        <p class="tweet-text">node-sqlcipher/sqlite3だとnode-gyp,node-addon-api,bindingsをnpmで追加するくらいで、N-APIへの改造が可能になるんだよね。forkしたのに追加して勉強しながらぼちぼちコードを書き換えていくスタイルで進めていこうと思う。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244400289223831552"
            target="_blank">2020/3/30 8:05:23</a></p>
      </header>
      <section>
        <p class="tweet-text">ただビルドスクリプトを見るに、electronへのサポートも入ってた。確かelectronって少しネイティブ・アドオンのABIが違ってたと思うんだよな。ちょっとそこが気になってるけどね。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244429131393064960"
            target="_blank">2020/3/30 9:59:59</a></p>
      </header>
      <section>
        <p class="tweet-text">ここを読んでる。<br/><blockquote class="card card-default"><header><img  src="https://avatars1.githubusercontent.com/u/9950313?s=400&v=4" /><a href="https://github.com/nodejs/node-addon-api/blob/master/doc/async_operations.md" target="_blank">node-addon-api/async_operations.md at master · nodejs/node-addon-api · GitHub</a></header><div>Module for using N-API from C++. Contribute to nodejs/node-addon-api development by creating an account on GitHub.</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244610403495108609"
            target="_blank">2020/3/30 22:00:18</a></p>
      </header>
      <section>
        <p class="tweet-text">AsyncWorkerとPromise::Defferedの組み合わせた使い方。。<br/><br/><a href="https://cdn2.hubspot.net/hubfs/106921/2020_Content%20Files/Tech%20White%20Paper%20%5BTWP%5D-Tech%20Blog%20%5BTBL%5D/Technical-Whitepaper-Next-Generation-Native-Node-Stephen-Brooks-2020.pdf" target="_blank">cdn2.hubspot.net/hubfs/106921/2…</a></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244610736891908096"
            target="_blank">2020/3/30 22:01:38</a></p>
      </header>
      <section>
        <p class="tweet-text">これのAnswerも参考になるかなあと。。<br/><br/><blockquote class="card card-default"><header><div class="no-image" >No Image</div><a href="https://www.gitmemory.com/issue/nodejs/node-addon-examples/85/551142933" target="_blank">Can you create example for async promise? - node-addon-examples</a></header><div></div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244610928919769088"
            target="_blank">2020/3/30 22:02:23</a></p>
      </header>
      <section>
        <p class="tweet-text">なんかいけそうな気がしてきたな。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244753206128726016"
            target="_blank">2020/3/31 7:27:45</a></p>
      </header>
      <section>
        <p class="tweet-text">恐る恐るC++コードを書き始める。。 https://t.co/GkR2xq9UkO</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/EUZAYsuU4AEqoNQ.png" />
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244753696459636737"
            target="_blank">2020/3/31 7:29:42</a></p>
      </header>
      <section>
        <p class="tweet-text">このコードのコンパイルを通すの結構大変だった。やはりgypの内容をある程度理解することが必要。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244836352425742337"
            target="_blank">2020/3/31 12:58:09</a></p>
      </header>
      <section>
        <p class="tweet-text">とりあえずsqlcipherではなくて、sqlite3ベースでまず作ろう。暗号化部分をどうするかは後で考えよう。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244960393501405184"
            target="_blank">2020/3/31 21:11:02</a></p>
      </header>
      <section>
        <p class="tweet-text">ちゅうかどっちでもいいか。。データベース本体を作ってるわけではなく、薄いラッパーを書こうとしてるだけだからね。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245481641956347911"
            target="_blank">2020/4/2 7:42:18</a></p>
      </header>
      <section>
        <p class="tweet-text">コードを書き始めている。がかなりの遅筆。そういえば参照っちゅうのがあったなあ。。とか参照はコンストラクタのイニシャライザ以外では初期化できんとかなあとか、constはJSと違って割と本物だなあとか、いろいろ思い出しながら書いてる。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245482881943658498"
            target="_blank">2020/4/2 7:47:13</a></p>
      </header>
      <section>
        <p class="tweet-text">が、このJS &lt;--&gt;C++間の情報をやりとりするためのコストは馬鹿にならないなあとコードを書くとより強く思う。こういう汎用なラッパーよりも、自分のアプリに特化したアドオンを作るほうがあたりまえだが効率はいいんだよな。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245484915929403393"
            target="_blank">2020/4/2 7:55:18</a></p>
      </header>
      <section>
        <p class="tweet-text">例えば認証部分を作る場合汎用ラッパーだとJSで<br/><br/>1. dbオープン<br/>2.クエリ発行、照合<br/>3.結果返却<br/><br/>まで書くけど、自前ネイティブ・アドオンならJS側は<br/>const user = await addon.login(user,pass);<br/>としてアドオンで上の処理を行えばJSとC++間の情報のやりとりが減ってパフォーマンスもよくなる。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245485667536097280"
            target="_blank">2020/4/2 7:58:17</a></p>
      </header>
      <section>
        <p class="tweet-text">とりあえず勉強がてら汎用的なアドオンを書いてみたいので続けるけど、実際使うものはもうちょっとアプリよりの汎用性のないものを作ろうかなあと思ったりしてるところである。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245832669046263809"
            target="_blank">2020/4/3 6:57:09</a></p>
      </header>
      <section>
        <p class="tweet-text">AsyncWorkerとPromiseを使ったsqlite3 dbのopen/closeのメソッドがとりあえず動いた。AsyncWorkerの実装はなかなかコード量が多い。といってもパターン化できるのでコピペ＋書き換えで済みそうだけど。 https://t.co/v34hXJjU5T</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/EUoWJkRUUAACN7m.png" />
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245832918800281601"
            target="_blank">2020/4/3 6:58:08</a></p>
      </header>
      <section>
        <p class="tweet-text">JS側はこんなテストコードを書いた。 https://t.co/FLOFH1enGL</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/EUoWZPaVAAs7ljZ.png" />
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245833202414972928"
            target="_blank">2020/4/3 6:59:16</a></p>
      </header>
      <section>
        <p class="tweet-text">ちなみに先ほどのスクショのコードだと以下のエラーが出る。<br/>TypeError: Option Paramater is missing.<br/>    at file:///home/sfpg/pj/node-sqlcipher/test/napi-test.mjs:7:12<br/>    at file:///home/sfpg/pj/node-sqlcipher/test/napi-test.mjs:12:3</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245833786035597312"
            target="_blank">2020/4/3 7:01:35</a></p>
      </header>
      <section>
        <p class="tweet-text">２つ目のパラメータが文字列ではなく整数値を期待しているのでそれ以外だとエラーが出るテストをしてた。C++例外がJSに伝搬するとドキュメントに書いてあったのでそのテストをしてみてたところ。。<br/><blockquote class="card card-default"><header><img  src="https://avatars1.githubusercontent.com/u/9950313?s=400&v=4" /><a href="https://github.com/nodejs/node-addon-api/blob/master/doc/error_handling.md#handling-errors-with-c-exceptions" target="_blank">node-addon-api/error_handling.md at master · nodejs/node-addon-api · GitHub</a></header><div>Module for using N-API from C++. Contribute to nodejs/node-addon-api development by creating an account on GitHub.</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245834669813149696"
            target="_blank">2020/4/3 7:05:06</a></p>
      </header>
      <section>
        <p class="tweet-text">エラーチェック部分のコードは以下<br/>if(info[1].IsNumber()){<br/>  mode = static_cast&lt;int&gt;(info[1].As&lt;Napi::Number&gt;());<br/>} else {<br/>  throw Napi::TypeError::New(env, "Option Paramater is missing.");<br/>}<br/><br/>普通にC++側でエラーをthrowするとそれがJS側に伝えられる。 https://t.co/hBu54TTI01</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/EUoXpZGUwAErn3T.png" />
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245835813230743552"
            target="_blank">2020/4/3 7:09:39</a></p>
      </header>
      <section>
        <p class="tweet-text">あとこのoptionというかオープンするときのパラメータはJSだとふつうオブジェクトで指定する。これをC++側で受け取ってint型の整数にまとめるようにしないといけないかなと思っている。なんかC++側の定数もJSにexportできるみたいなんで、C風にビットパターンorで指定するのでいいかもしれないが。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245836862293344256"
            target="_blank">2020/4/3 7:13:49</a></p>
      </header>
      <section>
        <p class="tweet-text">open/close部分だけでもかなりのコード量になっているが、まだまだ実用に乏しい実装で、もう少しいろいろ考えないといけない気もしている。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245838053823762433"
            target="_blank">2020/4/3 7:18:33</a></p>
      </header>
      <section>
        <p class="tweet-text">C++のクラスをJSのオブジェクトにラップするにはNapi::ObjectWrap&lt;&gt;を継承するんだけど、これテンプレートパラメータは＜継承する子クラス＞になってるんだよね。これってCRTPとかいうやつだよな。。 https://t.co/niVvj6CU3H</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/EUoahyQUwAUIgAg.png" />
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245838712321101826"
            target="_blank">2020/4/3 7:21:10</a></p>
      </header>
      <section>
        <p class="tweet-text">昔ATLとかWTLをいじってたことがあるが、これはもろCRTPを使ったライブラリであった。静的ポリモーフィズムを実現するためのテクニックだよな。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245839097903452160"
            target="_blank">2020/4/3 7:22:42</a></p>
      </header>
      <section>
        <p class="tweet-text">仮想関数のオーバーヘッドを気にしていた時代というのがあって、そのころに生み出されたものではないかなと思うけどね。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245840450969145345"
            target="_blank">2020/4/3 7:28:04</a></p>
      </header>
      <section>
        <p class="tweet-text">「Curiously Recurring Template Pattern」の略で、「奇妙な再帰テンプレートパターン」とでも訳すのだろうか。具象クラスを基底クラスに伝えるというのがなんとも不思議な感じが当時したものだ。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245841552921915392"
            target="_blank">2020/4/3 7:32:27</a></p>
      </header>
      <section>
        <p class="tweet-text">node-sqlite3と同じようにデータベースとステートメントに分けて実装しようと思う。これはsqlite3のハンドルポインタを考えれば自然とそうなるんだけども。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245842117328437249"
            target="_blank">2020/4/3 7:34:42</a></p>
      </header>
      <section>
        <p class="tweet-text">ハンドル（ポインタ）= インスタンス番号なのでそれをクラスメンバとして、そのハンドルのAPIをメンバ関数としてラップするのが自然な感じになるんだよな。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245842839491076097"
            target="_blank">2020/4/3 7:37:34</a></p>
      </header>
      <section>
        <p class="tweet-text">Cでオブジェクト指向的なアプローチをやろうとするとsqlite3のようなAPIになるんだよな。引数としてハンドルを渡す、つまりこれがthisポインタの代わりで、そこから情報を引き出して処理を行う感じ。Windows APIなんかもそんな感じですわな。HWND。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245844681767952384"
            target="_blank">2020/4/3 7:44:53</a></p>
      </header>
      <section>
        <p class="tweet-text">node-sqlite3では非同期処理やコールバックのためlibuvにうまくなじむようにBatonパターンちゅうので処理が細かく分割され実装されている。そのあたりの実装はAsyncWorkerに置き換えることでかなり実装が簡略化できそうな気がしている。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245845727940505601"
            target="_blank">2020/4/3 7:49:02</a></p>
      </header>
      <section>
        <p class="tweet-text">さらにnode-sqlite3では内部に実行スケジューラを持っていて直列・並列処理のコントロールを行っているが、今回Promiseベースのインターフェースで行うので、実行スケジューリングはJSのasync/awaitやPromise.all/race/thenあたりでするのでスケジューラは不要になる予定。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245845909641916416"
            target="_blank">2020/4/3 7:49:46</a></p>
      </header>
      <section>
        <p class="tweet-text">「最後まで飽きずに実装できれば」の話ですが。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1245889606983143425"
            target="_blank">2020/4/3 10:43:24</a></p>
      </header>
      <section>
        <p class="tweet-text">sqlite3.exec()ってコールバックで行データを返すのね。。これの対応どうしようかなあ。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246020954183962625"
            target="_blank">2020/4/3 19:25:20</a></p>
      </header>
      <section>
        <p class="tweet-text">コールバックが終わるまではPromise::resolve()しないようにしたらいいんだよな。コールバックとPromiseを併用するという奇妙なインターフェース。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246022450854297601"
            target="_blank">2020/4/3 19:31:16</a></p>
      </header>
      <section>
        <p class="tweet-text">node native addonのコードを書いていて思い出すのはdisp interfaceとかdual interfaceとか、ActiveX Objectのプログラミングですわな。。ATLでブラウザのコンポーネントを書いたり、WSHのオブジェクト書いたりとか。あれもまあよく出来たライブラリでしたなあ。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246023302318977026"
            target="_blank">2020/4/3 19:34:39</a></p>
      </header>
      <section>
        <p class="tweet-text">まだまだ分からんところが多いので、リークしないか気になっている。あれ、そういえばWSL2上のC++のコードをVS Codeでデバッグするのどうやるんだ（笑）。今のところprintfデバッグならぬstd::coutデバッグでやってるが（笑）。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246023716456124416"
            target="_blank">2020/4/3 19:36:18</a></p>
      </header>
      <section>
        <p class="tweet-text">そういえばなんかデバッグビルドでメモリ・リークチェックができたような気もするな。ああ、デバッグするにはデバッグバージョンでビルドしないといけないんだった！（笑）</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246040844903182336"
            target="_blank">2020/4/3 20:44:22</a></p>
      </header>
      <section>
        <p class="tweet-text">まあしかし、私がC++で遊べたのはやはりVisual Studio IDEのおかげなんだよなあ。コンパイル・デバッグがあんなに簡単にできるというのはやはりソフトウェアが優秀だったからということですわな。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246041074797166592"
            target="_blank">2020/4/3 20:45:17</a></p>
      </header>
      <section>
        <p class="tweet-text">多分VS Codeでエクステンションをほにゃららすれば比較的簡単にできるんだろうけど、明日試そう。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246207153737592832"
            target="_blank">2020/4/4 7:45:13</a></p>
      </header>
      <section>
        <p class="tweet-text">考えたらnodeのアドオンだからデバッグはそれなりに工夫は必要かもね。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246207675425144832"
            target="_blank">2020/4/4 7:47:17</a></p>
      </header>
      <section>
        <p class="tweet-text">HandleScopeの使いどころがいまいちわからんな。。オブジェクトをスイープされないようにするために使うのはわかるのだが。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246211634055372802"
            target="_blank">2020/4/4 8:03:01</a></p>
      </header>
      <section>
        <p class="tweet-text">AsyncWorker::Execute()中でのnode addon apiの呼び出しはできないのか。。そりゃそうか。。<br/><br/>As the method is not running on the main event loop, it must avoid calling any methods from node-addon-api or running any code that might invoke JavaScript.</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246213824014766081"
            target="_blank">2020/4/4 8:11:43</a></p>
      </header>
      <section>
        <p class="tweet-text">sqlite3_execのコールバックをきちんと処理するにはThreadSafeFunctionを使うほうがよさそうですな。。<br/><br/><blockquote class="card card-default"><header><img  src="https://avatars1.githubusercontent.com/u/9950313?s=400&v=4" /><a href="https://github.com/nodejs/node-addon-api/blob/master/doc/threadsafe_function.md" target="_blank">node-addon-api/threadsafe_function.md at master · nodejs/node-addon-api · GitHub</a></header><div>Module for using N-API from C++. Contribute to nodejs/node-addon-api development by creating an account on GitHub.</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246214786464899073"
            target="_blank">2020/4/4 8:15:33</a></p>
      </header>
      <section>
        <p class="tweet-text">ただまあsql injectionとか考えると、これでクエリすることはなさそうだし、返却値も型情報が失われ、テキストデータとして返されるから使い所は限られるかもね。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246215384480403456"
            target="_blank">2020/4/4 8:17:55</a></p>
      </header>
      <section>
        <p class="tweet-text">node_sqlite3がsqlite3_execのコールバックをサポートしないのも納得できるな。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246215801448742912"
            target="_blank">2020/4/4 8:19:35</a></p>
      </header>
      <section>
        <p class="tweet-text">なんだろうな、こういう言語間をつなぐ糊のようなコードを書くのもなかなか楽しいよな。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246216479336357888"
            target="_blank">2020/4/4 8:22:16</a></p>
      </header>
      <section>
        <p class="tweet-text">AsyncWorker::Execute中から行データを一行づつjsにコールバックしようとしてたが、それは仕様上できないということがわかったので、ThreadSafeFunctionで試してみることにしよう。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246216987937669121"
            target="_blank">2020/4/4 8:24:18</a></p>
      </header>
      <section>
        <p class="tweet-text">さっきHandleScopeの使い所で悩んでたけど、そりゃあかんわな。。AsyncWorker::Execute()中ではそもそも使えないもんね。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246415638702125058"
            target="_blank">2020/4/4 21:33:40</a></p>
      </header>
      <section>
        <p class="tweet-text">ようやくsqlite3_execのラッパー部分がJSで動くようになった。が、かなり不安定だ。。 https://t.co/C7OsOpwDlU</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/EUwoC8OUcAM0Pgt.png" />
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246416284184535041"
            target="_blank">2020/4/4 21:36:14</a></p>
      </header>
      <section>
        <p class="tweet-text">コールバックでデータを返すところで、ある条件下でsegmentation faultになってしまう。ウーム。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246600457696374784"
            target="_blank">2020/4/5 9:48:04</a></p>
      </header>
      <section>
        <p class="tweet-text">昨日のトラブルはコールバックの非同期性によるものだった。あたりまえといえば当たり前。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246603195385704449"
            target="_blank">2020/4/5 9:58:57</a></p>
      </header>
      <section>
        <p class="tweet-text">sqlite3_exec()はJS側では以下のように呼び出す。<br/>await db.exec("select * from test;",(row)=&gt; {<br/>  console.log(row);<br/>});<br/><br/>２つ目の引数にコールバックを渡すと、そのクエリがデータを返すものであった場合行ごとにコールバックが呼ばれるように考えた。この</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246603799495491589"
            target="_blank">2020/4/5 10:01:21</a></p>
      </header>
      <section>
        <p class="tweet-text">このメソッドはPromiseも返すようになっていて、コールバックによって行データがすべて返されたときにresolve()するように考えた。が、実際はコールバックがすべて行情報を返却する前にresolve()されてしまっていた。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246605346002440192"
            target="_blank">2020/4/5 10:07:29</a></p>
      </header>
      <section>
        <p class="tweet-text">ThreadSafeFunctionを使いAsyncWorkerのExecute()からメインスレッド上で実行が必要な処理を行うようにした。Execute()内は別のスレッドで動いていて、node addon api関連の処理は行えないようになっているからである。逆にいうとそういうことをしたければThreadSafeFunctionを使えということ。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246606846128836609"
            target="_blank">2020/4/5 10:13:27</a></p>
      </header>
      <section>
        <p class="tweet-text">sqlite3_execのコールバックはAsyncWorkerのスレッドで実行されるから、そこで得られた行データをThreadSafeFunction::BlockingCall使って引数で指定するコールバックに渡す。コールバックはメインスレッドで実行されるので、node addon apiが使えるようになる。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246608834598068224"
            target="_blank">2020/4/5 10:21:21</a></p>
      </header>
      <section>
        <p class="tweet-text">このコールバックでデータをJSのオブジェクトに変換して、JS側のコールバックFunctionを呼び出すのである。でここで問題なのはThreadSafeFunction::BlockingCallもしくはコールバックが非同期で行われるということである。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246609411050627072"
            target="_blank">2020/4/5 10:23:39</a></p>
      </header>
      <section>
        <p class="tweet-text">ThreadSafeFunction::BlockingCallは名前からすると同期呼び出しのように思うけど、実際は呼び出すコールバックを格納するキューに空きがない場合は空くまで待たされるというだけのことである。キューに渡された後いつ処理されるかはわからない。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246609973347409921"
            target="_blank">2020/4/5 10:25:53</a></p>
      </header>
      <section>
        <p class="tweet-text">以下のメソッドのコールバック部分は非同期で行われる。これ自体は期待した動きであるが、問題なのはPromise::resolve()の実行タイミングがコールバックが非同期なために掴めないことである。<br/>await db.exec("select * from test;",(row)=&gt; {<br/>  console.log(row);<br/>  rows.push(row);<br/>});</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246610756956590082"
            target="_blank">2020/4/5 10:29:00</a></p>
      </header>
      <section>
        <p class="tweet-text">今の時点ではAsyncWorker::OnOk()でPromiseをresolve()するようにしてるけど、さっき書いた通りコールバック自体はメインスレッドのキューに渡すので、AsyncWorkerのOnOk()は実際にコールバック呼び出しが完了してしまう前に呼び出されてしまうのだった。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246612470778609664"
            target="_blank">2020/4/5 10:35:48</a></p>
      </header>
      <section>
        <p class="tweet-text">つまりAsyncWorkerからメインスレッドに委託した処理の終了を検知してPromiseをresolve()しないと所望の動きにならない。そこをどうするか今考えているところ。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246709778228764672"
            target="_blank">2020/4/5 17:02:28</a></p>
      </header>
      <section>
        <p class="tweet-text">このへんところどころスレッドやスレッド・コンテキストの話が出てくるが、「node.jsはシングル・スレッドなのになぜ？」と思う人もいるだろう。私もかつては（といってもほんの少し前だが）そう思っていた。が、node.jsは非同期処理（ノンブロッキングな処理）を実現するためにスレッドを活用してる。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246711938970554371"
            target="_blank">2020/4/5 17:11:03</a></p>
      </header>
      <section>
        <p class="tweet-text">node.jsはI/Oをほぼ非同期で行えるが、それはlibuvで実現している。libuvはファイルI/OはブロッキングI/Oを使っているけど、そこをノン・ブロッキングであたかも行えているように見せるためにワーカー・スレッドを使ってる。つまりnode.js自体はマルチ・スレッドで動いている。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246712403296952321"
            target="_blank">2020/4/5 17:12:54</a></p>
      </header>
      <section>
        <p class="tweet-text">node.jsは例外的にファイルI/Oは同期的に処理が行えるけどこれはこの仕組み（ブロッキングI/O＋スレッドでノン・ブロッキングI/Oを実現）のおかげであると思う。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246713791330451461"
            target="_blank">2020/4/5 17:18:25</a></p>
      </header>
      <section>
        <p class="tweet-text">昔Windows APIでオーバーラップI/OとかIOCPとかを使ったファイルI/Oの実装を試したことがあったが、あれとよく似た感じである。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246716300472119296"
            target="_blank">2020/4/5 17:28:23</a></p>
      </header>
      <section>
        <p class="tweet-text">まあ今回のトラブルはそういう高尚な話に関係しているのではなく私の設計および実装がへたくそすぎるだけだが（笑）</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246716606224334848"
            target="_blank">2020/4/5 17:29:36</a></p>
      </header>
      <section>
        <p class="tweet-text">実際sqlite3_execを呼び出しているコードは以下である。<br/>char* message = nullptr;<br/>int status = sqlite3_exec(<br/>  const_cast&lt;sqlite3*&gt;(db_.handle()),<br/>  const_cast&lt;char*&gt;(sqlStatement_.c_str()),<br/>  need_callback_ ? exec_callback : 0,<br/>  this,<br/>  &amp;message<br/>);</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246718038675603458"
            target="_blank">2020/4/5 17:35:17</a></p>
      </header>
      <section>
        <p class="tweet-text">このsqlite3_exec() は同期的にexec_callbackが呼び出される（need_callback_ がtrueであった場合）。もしsqlStatementが行データを返すのであれば全行分のコールバックがここで発生する。このAPIの完了=すべての行返却済みとなるはずである。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246718847115120640"
            target="_blank">2020/4/5 17:38:30</a></p>
      </header>
      <section>
        <p class="tweet-text">でこの処理自体はAsyncWorker::Execute()内で行っているので、Execute()を抜けるつまりAsyncWorker::OnOk()が呼び出された時点でPromise::resolve()すれば良い。エラーならOnError()でreject()すればよい。と最初思ってた。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246720314324578310"
            target="_blank">2020/4/5 17:44:20</a></p>
      </header>
      <section>
        <p class="tweet-text">が途中でsqlite3_exec()のコールバック中にあるJSへのコールバック（JSへの行データ返却）を非同期に変更したため、「AsyncWorker::Execute()の完了時点でJSへ行データをすべて返却している」前提が崩れてしまった。というのが問題のもう少し詳細な話。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246721117550571520"
            target="_blank">2020/4/5 17:47:32</a></p>
      </header>
      <section>
        <p class="tweet-text">少し前にAsyncWorkerではなくThreadSafeFunctionで置き換えるみたいなことを言っていたがこれは間違い。AsyncWorker内でもThreadSafeFunctionは使える。ThreadSafeFunctionはメインスレッド以外からメインスレッドのコンテキストでJS関数を呼び出す（C++関数も呼べる）ものなので。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246722299421548544"
            target="_blank">2020/4/5 17:52:13</a></p>
      </header>
      <section>
        <p class="tweet-text">ワーカー・スレッドからメイン・スレッドに対して非同期処理をお願いしてるので、ワーカー・スレッドがお願いした非同期処理の完了を検知できればこの問題は解決する。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246726118436028416"
            target="_blank">2020/4/5 18:07:24</a></p>
      </header>
      <section>
        <p class="tweet-text">流れは<br/><br/>１．メインがワーカーを起動し処理を委託<br/>２．ワーカーが処理してメインに非同期でコールバック<br/>３．ワーカーがメインへのコールバックが完了することを確認してメインにPromiseで完了を通知<br/>４．メインはPromiseで完了を受け取る<br/><br/>こうしたいところ。うまくいかんけど。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246744299636576256"
            target="_blank">2020/4/5 19:19:39</a></p>
      </header>
      <section>
        <p class="tweet-text">node-addon-apiはn-apiをすべて網羅しているわけではなさそう。解決の糸口を見つける意味でもn-apiも調べてみるか。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246898593446768640"
            target="_blank">2020/4/6 5:32:45</a></p>
      </header>
      <section>
        <p class="tweet-text">この辺をじっくり読もうと思っている。。<br/><blockquote class="card card-default"><header><div class="no-image" >No Image</div><a href="https://nodejs.org/api/n-api.html#n_api_asynchronous_thread_safe_function_calls" target="_blank">N-API | Node.js v14.8.0 Documentation</a></header><div></div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246917957076180992"
            target="_blank">2020/4/6 6:49:42</a></p>
      </header>
      <section>
        <p class="tweet-text">じっくり読んだが、 node-addon-apiのドキュメント以上のことは書いてなかった。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246918988560363522"
            target="_blank">2020/4/6 6:53:48</a></p>
      </header>
      <section>
        <p class="tweet-text">ただ気づいた点として、ThreadSafeFunctionはそれ自体でワーカースレッドをいくつか作るということだ。つまりAsyncWorkerを使うとそれ自体でスレッドが1つ、ThreadSafeFunctionで少なくとも一つ作られることになる。つまり最低でも3つのスレッドで協調動作させる必要があるということ。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246919839437844481"
            target="_blank">2020/4/6 6:57:11</a></p>
      </header>
      <section>
        <p class="tweet-text">ThreadSafeFunctionのワーカースレッドはメインスレッドのキューにワークを突っ込むために用いられると思われる。これはおそらくワーカースレッドのブロックを防ぐためだと推測する。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246922027241336832"
            target="_blank">2020/4/6 7:05:52</a></p>
      </header>
      <section>
        <p class="tweet-text">ThreadSafeFunctionはNew()でキューサイズとワーカースレッド数を指定する。それぞれに1を設定して、<br/>BlockingCallで呼び出すとAsyncWorkerのワーカースレッドとThreadSafeFunctionのワーカースレッドが協調して同期的にコールバックをメインスレッドのキューに送ることができる。がこれは、</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246922761462661120"
            target="_blank">2020/4/6 7:08:47</a></p>
      </header>
      <section>
        <p class="tweet-text">あくまでメインスレッドのキューに送るとこまでを同期的に行うだけで、メインスレッドでいつコールバックが行われるかわからない。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246923232587829248"
            target="_blank">2020/4/6 7:10:40</a></p>
      </header>
      <section>
        <p class="tweet-text">Windows APIでいうところのPostMessageではなくSendMessageみたいな処理がしたいところ。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246924551432224768"
            target="_blank">2020/4/6 7:15:54</a></p>
      </header>
      <section>
        <p class="tweet-text">でThreadSafeFunctionでワーカースレッド使われるのならAsyncWorkerいらないんじゃない？と思ったが、このワーカースレッドは自前処理を走らせることはできないんだな、これが。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1246924650925281281"
            target="_blank">2020/4/6 7:16:18</a></p>
      </header>
      <section>
        <p class="tweet-text">コールバックを呼び出すことだけ。基本は。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247098692655386626"
            target="_blank">2020/4/6 18:47:52</a></p>
      </header>
      <section>
        <p class="tweet-text">まだ完成には程遠いが、ここまでのC++側のコードはこんな感じ。。<br/><br/><blockquote class="card card-large"><header><img  src="https://github.githubassets.com/images/modules/gists/gist-og-image.png" /><a href="https://gist.github.com/sfpgmr/0b46e809348c8e5d59cc334f129269e7" target="_blank">sqlite3-napi.cc · GitHub</a></header><div>GitHub Gist: instantly share code, notes, and snippets.</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247099057442443265"
            target="_blank">2020/4/6 18:49:19</a></p>
      </header>
      <section>
        <p class="tweet-text">Statementにはまだまったく手を付けていない。「sqlite3_execをなんとか行ごとに非同期コールバックでデータを返却したい」問題で停滞しているので。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247099391636168705"
            target="_blank">2020/4/6 18:50:39</a></p>
      </header>
      <section>
        <p class="tweet-text">いったんsqlite3_execが返す行データを、いったんAsyncWorkerでキャッシュしてメイン・スレッドに返すという手もあるけど中間で消費するメモリがなあ。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247123656989216769"
            target="_blank">2020/4/6 20:27:04</a></p>
      </header>
      <section>
        <p class="tweet-text">ちょっとsqlite3_exec()のソースコードを読んでいた。コールバック<br/>int(*callback)(void*,int,char** values,char** columnNames)でセットされるvaluesとcolumnNamesのメモリって解放しなくていいの？というのとライフタイムはどうなってるの？というところが疑問だったので。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247125530811363328"
            target="_blank">2020/4/6 20:34:31</a></p>
      </header>
      <section>
        <p class="tweet-text">結論からいうと、<br/>valuesやcolumnNamesの中身は放っておいてよい。sqlite3側で自動的に開放されるようだ。ライフタイムはコールバック終了までと考えておいたほうがよさそうだ。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247125991660507141"
            target="_blank">2020/4/6 20:36:21</a></p>
      </header>
      <section>
        <p class="tweet-text">今抱えている問題はまだ方向性を見いだせていない。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247126970191605760"
            target="_blank">2020/4/6 20:40:14</a></p>
      </header>
      <section>
        <p class="tweet-text">ちなみにsqlite3_exec()はスレッド・セーフであった。処理はmutexで排他制御されてるね。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247127083479789568"
            target="_blank">2020/4/6 20:40:41</a></p>
      </header>
      <section>
        <p class="tweet-text">sqlite3はマルチスレッド・サポートされてるから当然か。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247127489685540865"
            target="_blank">2020/4/6 20:42:18</a></p>
      </header>
      <section>
        <p class="tweet-text">しかしこうなるとコールバックされてる間は確実に同期的に処理されるので、これをあえて非同期に分解する意味はあるのだろうかと思ったりする。おそらくないだろうな（笑）。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247288146389164032"
            target="_blank">2020/4/7 7:20:42</a></p>
      </header>
      <section>
        <p class="tweet-text">まだちょっと完全ではないが、Promise::Deferred::resolve()の動作タイミングをsqlite3_exec()のコールバック完了後に持ってくることができた。今ちょっとメモリのマネジメントにむずかしさを感じているところ。C++ならではの話。ガベコレがある言語では不要な思考。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247289223348027392"
            target="_blank">2020/4/7 7:24:59</a></p>
      </header>
      <section>
        <p class="tweet-text">JSでこういうコードを書く。そして実行すると<br/><br/>await <a href="http://db.open" target="_blank">db.open</a>("./test.db");<br/>await db.exec("select * from test;",(row)=&gt; {<br/>  rows.push(row);<br/>});<br/><blockquote class="card card-default"><header><div class="no-image" >No Image</div><a href="http://console.info" target="_blank">Console.info domain is for sale | Buy with Epik.com</a></header><div></div></blockquote>(rows);<br/>rows.forEach(element =&gt; {<br/>  <blockquote class="card card-default"><header><div class="no-image" >No Image</div><a href="http://console.info" target="_blank">Console.info domain is for sale | Buy with Epik.com</a></header><div></div></blockquote>(element);<br/>});<br/>await db.close();</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247289633538334720"
            target="_blank">2020/4/7 7:26:36</a></p>
      </header>
      <section>
        <p class="tweet-text">出力結果はこうなって、最後に「Segmentation fault」がでる。<br/>[<br/>  { a: 'aaaa', b: 'aa' },<br/>  { a: 'bbbb', b: 'bb' },<br/>  { a: 'cccc', b: 'cc' }<br/>]<br/>{ a: 'aaaa', b: 'aa' }<br/>{ a: 'bbbb', b: 'bb' }<br/>{ a: 'cccc', b: 'cc' }<br/>Segmentation fault</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247289961692327936"
            target="_blank">2020/4/7 7:27:55</a></p>
      </header>
      <section>
        <p class="tweet-text">db.execはコールバック呼び出しが終わるまでawaitできるようになった。がなぜかSegmentation faultが出てしまう。おそらく何らかの凡ミスであるとは思うのだが。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247290194769764352"
            target="_blank">2020/4/7 7:28:50</a></p>
      </header>
      <section>
        <p class="tweet-text">ちなみにsqlite3_exec()で返る行データはオブジェクトで返すようにしてみている。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247311327145541633"
            target="_blank">2020/4/7 8:52:48</a></p>
      </header>
      <section>
        <p class="tweet-text">vs code でnode native addonをデバッグする方法がわかったので、今後はそれ使ってseg faultの原因を究明することにした。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247311462512484355"
            target="_blank">2020/4/7 8:53:21</a></p>
      </header>
      <section>
        <p class="tweet-text">おそらくメモリ管理あたりの凡ミスだと思うけどね。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247326782228795393"
            target="_blank">2020/4/7 9:54:13</a></p>
      </header>
      <section>
        <p class="tweet-text">vs code にアドオンを入れてlaunch.jsonを書くだけで済んだ。<br/><br/><blockquote class="card card-large"><header><img  src="https://miro.medium.com/max/490/0*8WYXGmOEpIl89da5.jpg" /><a href="https://medium.com/@atulanand94/debugging-nodejs-c-addons-using-vs-code-27e9940fc3ad" target="_blank">🐞 Debugging NodeJS C++ addons using VS Code | by Atul | Medium</a></header><div>I believe that programming in a new language or domain seems hard until you know how to debug properly.</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247327250858545158"
            target="_blank">2020/4/7 9:56:05</a></p>
      </header>
      <section>
        <p class="tweet-text">まあvs codeもエディタの域を超えて、IDEと言っても差し支えないような感じになってるなあ。。本家のvsは使わなくなって数年経つが、どうなってんだろうな。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247626214186971136"
            target="_blank">2020/4/8 5:44:03</a></p>
      </header>
      <section>
        <p class="tweet-text">lldbでデバッグした結果、やはり凡ミスだった。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247627969742299136"
            target="_blank">2020/4/8 5:51:02</a></p>
      </header>
      <section>
        <p class="tweet-text">複数のクエリもちゃんと返ってくる！！<br/>await db.exec("select * from test;select * from test2;",(r)=&gt;{<br/>     rows.push(r);<br/>}); https://t.co/f5BbL31tQ4</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/EVB2zmvU8AAxA1t.png" />
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248006585449730049"
            target="_blank">2020/4/9 6:55:31</a></p>
      </header>
      <section>
        <p class="tweet-text">今はsqlite3_load_extension()とsqlite3_config()のwrapperを書いているところ。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248379143089057792"
            target="_blank">2020/4/10 7:35:56</a></p>
      </header>
      <section>
        <p class="tweet-text">ちょっとここに来てラッパーのベースとなるライブラリをsqlcipherからsqlite3にいったん戻そう。暗号化については別途考えることにする。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248415875658469379"
            target="_blank">2020/4/10 10:01:53</a></p>
      </header>
      <section>
        <p class="tweet-text">とりあえずDatabaseに関する実装は終わり、ベースのライブラリをsqlite3に変更した。続いてStatementの実装をしようと思う。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248503752539029504"
            target="_blank">2020/4/10 15:51:05</a></p>
      </header>
      <section>
        <p class="tweet-text">Statementの実装をしていると同期メソッドも用意しておいたほうがいいなあと思ってくる。もともとのsqlite3のAPIがビジー状態を防ぐような作りになってる気がするんだな。SQL発行→行取得までの処理が分割されてAPIとして提供されているところとかね。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248505047907876869"
            target="_blank">2020/4/10 15:56:14</a></p>
      </header>
      <section>
        <p class="tweet-text">非同期コールバックをワーカースレッドでやるというのはそれ自体かなりオーバーヘッドがある。sqlite3のAPIがあのようなつくりなのでメインスレッドをさほど占有しない気がして、ワーカーに預ける意味ってあまりないんじゃないかなと思ったりする。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248507065544265728"
            target="_blank">2020/4/10 16:04:15</a></p>
      </header>
      <section>
        <p class="tweet-text">まあしかしjsからのメソッド呼び出しが都度イベントループに突っ込まれるかというと、そうでもないよな。とするとこの考えは少しおかしいかな・・。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248507782480846849"
            target="_blank">2020/4/10 16:07:06</a></p>
      </header>
      <section>
        <p class="tweet-text">ThreadSafeFunctionを使ってコールバックするという手もあるよな。これだとコールバックのたびにメインのイベントループに突っ込まれるもんな。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248508092792197120"
            target="_blank">2020/4/10 16:08:20</a></p>
      </header>
      <section>
        <p class="tweet-text">このあたりもうちょっとv8やlibuvのことがわからんとはっきりしないよなあ。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248581962387746816"
            target="_blank">2020/4/10 21:01:52</a></p>
      </header>
      <section>
        <p class="tweet-text">Statementは結局同期・非同期両方のメソッドを用意することにした。ただいま実装中。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248753589465444352"
            target="_blank">2020/4/11 8:23:51</a></p>
      </header>
      <section>
        <p class="tweet-text">sqlite3_bind_xxの実装をしているところで、このIssueに引っかかった。。<br/><br/><blockquote class="card card-default"><header><img  src="https://avatars1.githubusercontent.com/u/9950313?s=400&v=4" /><a href="https://github.com/nodejs/node-addon-api/issues/57" target="_blank">More special types check · Issue #57 · nodejs/node-addon-api · GitHub</a></header><div>node-sqlite3 uses val.IsDate(), val.IsRegExp(), val.IsInt32(). I think we need to think about how to support these.</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248753891644076032"
            target="_blank">2020/4/11 8:25:03</a></p>
      </header>
      <section>
        <p class="tweet-text">まずnode-sqlite3をN-APIもしくはnode-addon-apiでリライトしようという人たちがいるということがわかったね。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248755356773187584"
            target="_blank">2020/4/11 8:30:52</a></p>
      </header>
      <section>
        <p class="tweet-text">Napi::Valueで整数か実数かを判定するメソッドがないという問題。IsInt32()があればいいんだけどね。なぜかない。node-sqlite3ではv8のValueを使っているんでIsInt32()が使える。型判定メソッドはv8のValueの方が豊富である。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248756897148063747"
            target="_blank">2020/4/11 8:36:59</a></p>
      </header>
      <section>
        <p class="tweet-text">たしかJSはDoubleの仮数部56ビットのうち、32ビット分を使って整数値を格納しているはずなんだな。なのでいったんDoubleに変換した後でビットベースでチェックすれば整数だとわかるはず。。これはECMAScriptの規格だからJSのエンジンによる実装の違いはないと思う。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248757244230914051"
            target="_blank">2020/4/11 8:38:22</a></p>
      </header>
      <section>
        <p class="tweet-text">V8のIsInt32の実装を見てみればいいんだな。あとはエンディアンか。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248764526712913920"
            target="_blank">2020/4/11 9:07:18</a></p>
      </header>
      <section>
        <p class="tweet-text">node-sqlite3でも議論されてるよね。<br/><blockquote class="card card-default"><header><img  src="https://avatars2.githubusercontent.com/u/600935?s=400&v=4" /><a href="https://github.com/mapbox/node-sqlite3/issues/830" target="_blank">N-API Support for node-sqlite3 · Issue #830 · mapbox/node-sqlite3 · GitHub</a></header><div>The recently announced Node 8 has a new experimental feature called N-API which is aimed at reducing maintenance cost for node native addons. Checkout this blog for more details on its benefits. Mo...</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248766163959439360"
            target="_blank">2020/4/11 9:13:49</a></p>
      </header>
      <section>
        <p class="tweet-text">私が作成中のものはsqlite3のAPIに寄せようと思っていて、node-sqlite3のrun/get/eachとかはどうしようかなと思っている。この部分が一番asyncが使えるところだから実装すべきなんだけどね。今ではasync functionがJSで使え、ループで代替できるから、実装する必要性がさほどないような気もしている。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248766619351826432"
            target="_blank">2020/4/11 9:15:37</a></p>
      </header>
      <section>
        <p class="tweet-text">あ、さっきの56ビットじゃなくて53ビットだった。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248769830590636033"
            target="_blank">2020/4/11 9:28:23</a></p>
      </header>
      <section>
        <p class="tweet-text">V8のソースをgit cloneしてIsInt32()の実装を読んでみることにする。なんかネット上のソースを見た感じではやっぱりビットパターンで整数値かどうかの判定をしてそうなのだが、もうちょっとちゃんとチェックしたいので。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1248770814859546624"
            target="_blank">2020/4/11 9:32:17</a></p>
      </header>
      <section>
        <p class="tweet-text">IsInt32()の実装はこれ。IsSmi()がtrueもしくはIsInt32Double()がtrueであればInt32であるということがわかるのですな。じゃあそれを読もう。 https://t.co/bDQLFP1Mv9</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/EVSGKYvUUAAPWNI.png" />
        
      </section>
      
    </article>
    
    <article>
      
      
      <header class="tweet-header">
        
        <img class="tweet-profile-img"  src="https://pbs.twimg.com/profile_images/1231176331628433408/1rqOW5xD_normal.jpg" />
        <p class="tweet-user-name">κeen@blackenedgold</p>
        
        <p class="tweet-date"><a href="https://twitter.com/blackenedgold/status/1247172631880589317"
            target="_blank">2020/4/6 23:41:41</a></p>
      </header>
      <section>
        <p class="tweet-text">かなり本格的にインタプリタを作る記事らしい。目次眺めた感じ、VM作ってるしGCも書いてるしclassもあるしNaN boxingとかもしてるし、ここまで充実した資料ほとんどないよね。<br/><br/>Crafting Interpreters<br/><a href="http://craftinginterpreters.com/" target="_blank">craftinginterpreters.com</a></p>
        
      </section>
      
    </article>
    
    <article>
      
      
      <header class="tweet-header">
        
        <img class="tweet-profile-img"  src="https://pbs.twimg.com/profile_images/1212701145379946496/pSDVrvWj_normal.png" />
        <p class="tweet-user-name">S.F.@SFPGMR</p>
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247328008559415296"
            target="_blank">2020/4/7 9:59:06</a></p>
      </header>
      <section>
        <p class="tweet-text">時差出勤してるが今日は昨日に比べてガラガラだなあ、電車。ちなみに明日はテレワーク。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247328374919327744"
            target="_blank">2020/4/7 10:00:33</a></p>
      </header>
      <section>
        <p class="tweet-text">いつもこれくらいだと嬉しいけどね。。コロナで労働環境が良くなってるという、なんとも皮肉な現実だわ。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1247328967331213318"
            target="_blank">2020/4/7 10:02:54</a></p>
      </header>
      <section>
        <p class="tweet-text">多分リモートワークで生産性を高め、成果を出すような仕事の仕方を普段からしとけばこういうリスクにも強いよな。。</p>
        
      </section>
      
    </article>
    
    <article>
      
      
      <header class="tweet-header">
        
        <img class="tweet-profile-img"  src="https://pbs.twimg.com/profile_images/617722474327732224/kEGNMW1w_normal.png" />
        <p class="tweet-user-name">b.p.s.@BasicProgrammer</p>
        
        <p class="tweet-date"><a href="https://twitter.com/BasicProgrammer/status/1246108439463333888"
            target="_blank">2020/4/4 1:12:58</a></p>
      </header>
      <section>
        <p class="tweet-text">BASICで３DCG、MSX turboRでもやってみました。<br/>88版ほぼそのまま動きました(^^)<br/>TIMEは36063だったので、10分1秒でした。 <a href="https://twitter.com/Stosstruppe/status/1245682316325740545" target="_blank">twitter.com/Stosstruppe/st…</a> https://t.co/OwK4VIWFux</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/EUsOI9uU8AAWw9i.png" />
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/EUsOyPlU4AEy45P.png" />
        
      </section>
      
    </article>
    
    <article>
      
      
      <header class="tweet-header">
        
        <img class="tweet-profile-img"  src="https://pbs.twimg.com/profile_images/1212701145379946496/pSDVrvWj_normal.png" />
        <p class="tweet-user-name">S.F.@SFPGMR</p>
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1244968563502239744"
            target="_blank">2020/3/31 21:43:30</a></p>
      </header>
      <section>
        <p class="tweet-text">みさき公園。。懐かしい。。子供ころ2－3回いったかなあ。。 <blockquote class="card card-default"><header><div class="no-image" >No Image</div><a href="https://t.co/mNkYVgYnZj" target="_blank"></a></header><div></div></blockquote></p>
        
      </section>
      
    </article>
    
    <article>
      
      
      <header class="tweet-header">
        
        <img class="tweet-profile-img"  src="https://pbs.twimg.com/profile_images/1212701145379946496/pSDVrvWj_normal.png" />
        <p class="tweet-user-name">S.F.@SFPGMR</p>
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1243670689854431245"
            target="_blank">2020/3/28 7:46:13</a></p>
      </header>
      <section>
        <p class="tweet-text">なんかすごい世界だ。。<br/><br/><div class="youtube" data-type="yt" id="-Lr_UBHVgmo"><div class="yt-title">Youtube - FIGHT CRAB 1st Trailer</div><svg class="player-play" width="64" height="64" xmlns="http://www.w3.org/2000/svg"><g><path class="player-play-1" fill="#ffffff" stroke-width="1" d="m0,0l64,32l-64,32l0,-64z" /></g></svg><img  data-href="https://youtu.be/-Lr_UBHVgmo" class="youtube" src="https://i.ytimg.com/vi/-Lr_UBHVgmo/hqdefault.jpg" /></div>   <br/></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1243671545618333703"
            target="_blank">2020/3/28 7:49:37</a></p>
      </header>
      <section>
        <p class="tweet-text">『完全にプロシージャルなアニメーションと誤魔化しのない正確なコリジョン』</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1243671692108390400"
            target="_blank">2020/3/28 7:50:12</a></p>
      </header>
      <section>
        <p class="tweet-text">『リアルファイトの感覚とカニになったような体験をあなたに与えます』<br/><br/>「カニになったような体験」かあ。</p>
        
      </section>
      
    </article>
    
    <article>
      
      
      <header class="tweet-header">
        
        <img class="tweet-profile-img"  src="https://pbs.twimg.com/profile_images/1212701145379946496/pSDVrvWj_normal.png" />
        <p class="tweet-user-name">S.F.@SFPGMR</p>
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242941374766280704"
            target="_blank">2020/3/26 7:28:11</a></p>
      </header>
      <section>
        <p class="tweet-text">このEMIT_EVENTマクロは中身みても今の時点では正直わからんなあ（笑）<br/><blockquote class="card card-default"><header><img  src="https://avatars0.githubusercontent.com/u/3806814?s=400&v=4" /><a href="https://github.com/sfpgmr/node-sqlcipher/blob/bca45de1b893323abb4cd49bdcf4f445574312d8/src/macros.h#L104-L109" target="_blank">node-sqlcipher/macros.h at bca45de1b893323abb4cd49bdcf4f445574312d8 · sfpgmr/node-sqlcipher · GitHub</a></header><div>SQLCipher bindings for Node. Contribute to sfpgmr/node-sqlcipher development by creating an account on GitHub.</div></blockquote> https://t.co/NTyKty1FMN</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/ET_Ql1qUwAAm7Cc.png" />
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242941833371516929"
            target="_blank">2020/3/26 7:30:00</a></p>
      </header>
      <section>
        <p class="tweet-text">そしてようやくqueueにpushするところまで来るのだが。でまあここで全部pushするのかと思いきや違うんだなこれが。。<br/><blockquote class="card card-default"><header><img  src="https://avatars0.githubusercontent.com/u/3806814?s=400&v=4" /><a href="https://github.com/sfpgmr/node-sqlcipher/blob/master/src/database.cc#L101-L107" target="_blank">node-sqlcipher/database.cc at master · sfpgmr/node-sqlcipher · GitHub</a></header><div>SQLCipher bindings for Node. Contribute to sfpgmr/node-sqlcipher development by creating an account on GitHub.</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242942719426625537"
            target="_blank">2020/3/26 7:33:31</a></p>
      </header>
      <section>
        <p class="tweet-text">openかつ（locked/exclusive/serializeがすべてfalse、もしくはpendingが0の時）はいきなりcallbackを呼んでいる。これはなぜかは現時点ではわからない。 https://t.co/w5QB7zCY8U</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/ET_RHLsU4AE7Jh9.png" />
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242944924883890176"
            target="_blank">2020/3/26 7:42:17</a></p>
      </header>
      <section>
        <p class="tweet-text">ちょっとDatabase::Process()に話が戻るけど、lockedにtrueがセットされるとそれがfalseにならない限りqueueに入った*Callは処理されない。lockedにfalseになるのはいつなのかというと、おそらく*Call中のcallbackの処理が終わり、コールバックするタイミングでlockedが解除されるんだろうなと推測。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242945549688426496"
            target="_blank">2020/3/26 7:44:46</a></p>
      </header>
      <section>
        <p class="tweet-text">*Call のexclusiveメンバがtrueである限り、Database::Process()でlockedにtrueがセットされ、*Callの処理が終わらないと解除されないので、それでDatabase::Serialize()の直列性を保証しているのだなといまいまは推測している。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242948907337797632"
            target="_blank">2020/3/26 7:58:07</a></p>
      </header>
      <section>
        <p class="tweet-text">と思ったが、lockedが明示的にfalseにセットされることはなかった。pendingというメンバが処理中（保留中？）を表すステータスのようである。Statementが処理されると+1され、処理が終わると-1されるようである。pendingが0だと処理されているものは何もないということかな？</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242951004326256640"
            target="_blank">2020/3/26 8:06:27</a></p>
      </header>
      <section>
        <p class="tweet-text">ソース見てるとそろそろuv::ちゅうのがちらほら見えてきてる。。nodeはlibuv使ってるんだよなあ。。<br/><br/><blockquote class="card card-default"><header><img  src="https://avatars1.githubusercontent.com/u/4030929?s=400&v=4" /><a href="https://github.com/libuv/libuv" target="_blank">GitHub - libuv/libuv: Cross-platform asynchronous I/O</a></header><div>Cross-platform asynchronous I/O. Contribute to libuv/libuv development by creating an account on GitHub.</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242973221353185280"
            target="_blank">2020/3/26 9:34:43</a></p>
      </header>
      <section>
        <p class="tweet-text">どうもBatonやらpendingやらという言葉はlibuvにちなんでるようですな。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242973850213601280"
            target="_blank">2020/3/26 9:37:13</a></p>
      </header>
      <section>
        <p class="tweet-text">Batonってリレーとかで使うやつだよなあ。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242980618775883778"
            target="_blank">2020/3/26 10:04:07</a></p>
      </header>
      <section>
        <p class="tweet-text">ちゅうかやはりlibuvやnodeのネイティブアドオンの知識が皆無な状態だとこれを読み解くのは難しいよな。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1243276665767124993"
            target="_blank">2020/3/27 5:40:30</a></p>
      </header>
      <section>
        <p class="tweet-text">libuvは非同期I/Oを実現するためのライブラリですな。そもそもnode.jsのために開発されたのか。。<br/><br/><blockquote class="card card-default"><header><img  src="https://avatars1.githubusercontent.com/u/4030929?s=400&v=4" /><a href="https://github.com/libuv/libuv" target="_blank">GitHub - libuv/libuv: Cross-platform asynchronous I/O</a></header><div>Cross-platform asynchronous I/O. Contribute to libuv/libuv development by creating an account on GitHub.</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1243280027241734145"
            target="_blank">2020/3/27 5:53:52</a></p>
      </header>
      <section>
        <p class="tweet-text">イベント・ループという言葉を聞くとメッセージ・ループを当然思い出すわけですが。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1243284229904986112"
            target="_blank">2020/3/27 6:10:34</a></p>
      </header>
      <section>
        <p class="tweet-text">これを読みつつ、libuvをビルドしている。exampleコードを実際動かしてみたくなったので。。<br/><br/><blockquote class="card card-default"><header><div class="no-image" >No Image</div><a href="https://nikhilm.github.io/uvbook/index.html" target="_blank">Table of Contents — An Introduction to libuv</a></header><div></div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1243300207212654592"
            target="_blank">2020/3/27 7:14:03</a></p>
      </header>
      <section>
        <p class="tweet-text">uvbookのサンプルコードのレポジトリがあって、これ使えばいいのか。<br/><blockquote class="card card-default"><header><img  src="https://avatars1.githubusercontent.com/u/78682?s=400&v=4" /><a href="https://github.com/nikhilm/uvbook" target="_blank">GitHub - nikhilm/uvbook: An Introduction to libuv</a></header><div>An Introduction to libuv. Contribute to nikhilm/uvbook development by creating an account on GitHub.</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1243300718703869952"
            target="_blank">2020/3/27 7:16:05</a></p>
      </header>
      <section>
        <p class="tweet-text">ああ、やはりFile I/Oはスレッド・プール使って疑似的にノンブロッキングI/Oを実現するわけね。。<br/><br/><blockquote class="card card-default"><header><div class="no-image" >No Image</div><a href="https://nikhilm.github.io/uvbook/filesystem.html" target="_blank">Filesystem — An Introduction to libuv</a></header><div></div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1243301069750300672"
            target="_blank">2020/3/27 7:17:29</a></p>
      </header>
      <section>
        <p class="tweet-text">しかしC/C++は基本Windows + IDEでビルドしてた。gccやclangをコマンドラインで使うなんちゅうのはほとんどやったことないなあ。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1243302053851480065"
            target="_blank">2020/3/27 7:21:23</a></p>
      </header>
      <section>
        <p class="tweet-text">libuvではファイルシステムへのアクセスは同期・非同期の2種類用意しているとあるな。そのためにブロッキングI/O＋スレッド・プール使っているのかな。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1243302289923702784"
            target="_blank">2020/3/27 7:22:20</a></p>
      </header>
      <section>
        <p class="tweet-text">nodeもファイルI/Oは同期・非同期の2種類あるもんな。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1243305564307783686"
            target="_blank">2020/3/27 7:35:20</a></p>
      </header>
      <section>
        <p class="tweet-text">uvcatのサンプル。ちょっとここで「あれ？」ってなった。<br/><br/><blockquote class="card card-default"><header><div class="no-image" >No Image</div><a href="https://nikhilm.github.io/uvbook/filesystem.html#reading-writing-files" target="_blank">Filesystem — An Introduction to libuv</a></header><div></div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1243306173450735616"
            target="_blank">2020/3/27 7:37:45</a></p>
      </header>
      <section>
        <p class="tweet-text">基本的なところでだが。ファイルディスクリプタの1ってstdoutだったというところ。こんなのすっかり忘れてるわ。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1243308169591308288"
            target="_blank">2020/3/27 7:45:41</a></p>
      </header>
      <section>
        <p class="tweet-text">私ってfile streamingってあんまり使ってこなかったなあ。。<br/><br/><blockquote class="card card-default"><header><div class="no-image" >No Image</div><a href="https://nikhilm.github.io/uvbook/filesystem.html#filesystem-operations" target="_blank">Filesystem — An Introduction to libuv</a></header><div></div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1243312727868583937"
            target="_blank">2020/3/27 8:03:48</a></p>
      </header>
      <section>
        <p class="tweet-text">libuvの関数のフォーマットは<br/><br/>操作(イベントループ,ハンドル,パラメータ..,コールバック）<br/><br/>という感じですな。イベントループに対して処理をお願いして、コールバックで結果をもらう。FileSystemは例外的にコールバックをNULLにすると同期的に処理してくれる模様。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1243313000813125633"
            target="_blank">2020/3/27 8:04:53</a></p>
      </header>
      <section>
        <p class="tweet-text">Windows APIでもPostMessageは非同期的、SendMessageは同期的とかそういうのありましたなあ。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1243313530280890368"
            target="_blank">2020/3/27 8:06:59</a></p>
      </header>
      <section>
        <p class="tweet-text">あ、さっきの呼び出しのフォーマットは<br/><br/>リクエスト(イベントループ,ハンドル,パラメータ..,コールバック）<br/><br/>のほうがいいかも。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1243331279665287168"
            target="_blank">2020/3/27 9:17:31</a></p>
      </header>
      <section>
        <p class="tweet-text">ようやくuv_queue_work()が出てきた。<br/><blockquote class="card card-default"><header><div class="no-image" >No Image</div><a href="https://nikhilm.github.io/uvbook/threads.html#id1" target="_blank">Threads — An Introduction to libuv</a></header><div></div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1243341267964067840"
            target="_blank">2020/3/27 9:57:13</a></p>
      </header>
      <section>
        <p class="tweet-text">とりあえずuvbookを読み終えた。node_sqlite3の非同期性はuv_queue_work()を使って実現してるんだなあということがわかった。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1243341860686290944"
            target="_blank">2020/3/27 9:59:34</a></p>
      </header>
      <section>
        <p class="tweet-text">そういえばsqlite3が用意する同期オブジェクトを使ってるのをソースコード中に見かけたが、そういうわけかと納得。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1243343106642083841"
            target="_blank">2020/3/27 10:04:31</a></p>
      </header>
      <section>
        <p class="tweet-text">そしてBatonに関してもここに書いてあった。<br/><blockquote class="card card-default"><header><div class="no-image" >No Image</div><a href="https://nikhilm.github.io/uvbook/utilities.html#passing-data-to-worker-thread" target="_blank">Utilities — An Introduction to libuv</a></header><div></div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1243344452896223232"
            target="_blank">2020/3/27 10:09:52</a></p>
      </header>
      <section>
        <p class="tweet-text"><blockquote class="card card-default"><header><img  src="http://i.cmpnet.com/ddj/digital/ddj.gif" /><a href="http://www.drdobbs.com/batons-a-sequential-synchronization-obje/184416338" target="_blank">Batons: A Sequential Synchronization Object | Dr Dobb's</a></header><div>Win32 offers a variety of synchronization primitives (mutexes, events, semaphores, etc.). None of these are convenient choices when you need to serialize a sequence of tasks, however. There's no easy way to say "block until the Nth stage of this task is complete. This article describes and implements batons, a serial synchronization primitive that solves just this class of problem.</div></blockquote></p>
        
      </section>
      
    </article>
    
    <article>
      
      
      <header class="tweet-header">
        
        <img class="tweet-profile-img"  src="https://pbs.twimg.com/profile_images/1212701145379946496/pSDVrvWj_normal.png" />
        <p class="tweet-user-name">S.F.@SFPGMR</p>
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242970841161199616"
            target="_blank">2020/3/26 9:25:16</a></p>
      </header>
      <section>
        <p class="tweet-text">@Hoguchi373 ほとんどの言語はよくわかってないのではないでしょうか。私の場合。C言語の理解もこの程度ですし。お恥ずかしい限りですが。</p>
        
      </section>
      
    </article>
    
    <article>
      
      
      <header class="tweet-header">
        
        <img class="tweet-profile-img"  src="https://pbs.twimg.com/profile_images/1212701145379946496/pSDVrvWj_normal.png" />
        <p class="tweet-user-name">S.F.@SFPGMR</p>
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242954039374966784"
            target="_blank">2020/3/26 8:18:30</a></p>
      </header>
      <section>
        <p class="tweet-text">@Hoguchi373 文字列の終端が0というやつですね。実はあまりC言語は詳しくないんですよね。。</p>
        
      </section>
      
    </article>
    
    <article>
      
      
      <header class="tweet-header">
        
        <img class="tweet-profile-img"  src="https://pbs.twimg.com/profile_images/1212701145379946496/pSDVrvWj_normal.png" />
        <p class="tweet-user-name">S.F.@SFPGMR</p>
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242245481813573633"
            target="_blank">2020/3/24 9:22:57</a></p>
      </header>
      <section>
        <p class="tweet-text">自分用cmsのデータストア先としてsqlite3を使おうと思っていてですな。考えるとredisとかでもいいような・・と思いつつsqlite3の勉強をしているのですわ。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242246083817779200"
            target="_blank">2020/3/24 9:25:20</a></p>
      </header>
      <section>
        <p class="tweet-text">そしてnodeバインディングであるnode-sqlite3を使ってみてるのですがこれがなかなかすごいモジュールで。こんなに非同期なモジュールもないよな..と思うような非同期性を有しているものでして。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242247239277277187"
            target="_blank">2020/3/24 9:29:56</a></p>
      </header>
      <section>
        <p class="tweet-text">何が？というと「基本非同期」というとこがすごいわけで。ステートメント書くとデフォルトですべて非同期で実行される。つまり<br/><br/><blockquote class="card card-default"><header><div class="no-image" >No Image</div><a href="http://db.run" target="_blank">尼克地带－传播、沟通、分享。</a></header><div></div></blockquote>("select～"); // 1.<br/><a href="http://db.run" target="_blank">db.run</a>("update～"); // 2.<br/><br/>1.,2.の実行順序が保証されないのである。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242247744078483456"
            target="_blank">2020/3/24 9:31:56</a></p>
      </header>
      <section>
        <p class="tweet-text">保証するには以下のように書けばいい。<br/><br/>db.serialize(()=&gt; {<br/>  <blockquote class="card card-default"><header><div class="no-image" >No Image</div><a href="http://db.run" target="_blank">尼克地带－传播、沟通、分享。</a></header><div></div></blockquote>("select～"); // 1.<br/>  <a href="http://db.run" target="_blank">db.run</a>("update～"); // 2.<br/>]);<br/><br/>こうすると1.,2.の順序実行が保証されるのですな。がしかしdb.serialize()自体は非同期で実行されるですわ。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242250244307312641"
            target="_blank">2020/3/24 9:41:52</a></p>
      </header>
      <section>
        <p class="tweet-text">でこのdb.serialize()が終わったことをどうやって知るのかという点で困っていて。db.serialize()がcall backもしくはpromiseで完了を通知してくれると思いきや、通知してくれないんですな。これが。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242251959765069824"
            target="_blank">2020/3/24 9:48:41</a></p>
      </header>
      <section>
        <p class="tweet-text"><blockquote class="card card-default"><header><div class="no-image" >No Image</div><a href="http://db.run" target="_blank">尼克地带－传播、沟通、分享。</a></header><div></div></blockquote> 自体には完了コールバックがあるから、db.serialize()に仕込んだ最後の<a href="http://db.run" target="_blank">db.run</a> にコールバックを入れればいんだろうけど、ちょっとそれってちょっとかっこ悪い実装になっちゃうよなあと思ってね。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242255323378774016"
            target="_blank">2020/3/24 10:02:03</a></p>
      </header>
      <section>
        <p class="tweet-text"><a href="http://db.run" target="_blank">db.run</a>等のDML/DDLを発行するAPI自体はutil.promisifyでラップできる仕様になってるので、それでラップして使ってdb.serialize/parallelizeを使わないでpromiseベースでcontrol-flowを実現するというのは考えたんだよな。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242256120778911745"
            target="_blank">2020/3/24 10:05:13</a></p>
      </header>
      <section>
        <p class="tweet-text">しかしそうするとこのライブラリのエレガントな感じ（個人的感想ですが）が損なわれるのがちょっとなあと思ったりもして。db.serlialize/parallelizeがコール・バックすれば済む問題だから、ライブラリをforkしてそこだけ付け足すというのもありだと思うし。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242256473310121984"
            target="_blank">2020/3/24 10:06:37</a></p>
      </header>
      <section>
        <p class="tweet-text">NANいじれる知識があるかというとあまりとういうかほとんどないんだけどね（笑）。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242256859819470849"
            target="_blank">2020/3/24 10:08:10</a></p>
      </header>
      <section>
        <p class="tweet-text">それ付け足すんだったらついでにPromiseベースのインターフェースをつければいいじゃないかなとも思うな。。ちょっといじってみようかなと思うけど。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242257234945404929"
            target="_blank">2020/3/24 10:09:39</a></p>
      </header>
      <section>
        <p class="tweet-text">たぶんforkしてこういうインターフェースをくっつけてる人いると思うんだけどね。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242257978025099264"
            target="_blank">2020/3/24 10:12:36</a></p>
      </header>
      <section>
        <p class="tweet-text">これがそれに近いね。<br/><br/><blockquote class="card card-default"><header><img  src="https://avatars3.githubusercontent.com/u/773036?s=400&v=4" /><a href="https://github.com/kriasoft/node-sqlite" target="_blank">GitHub - kriasoft/node-sqlite: SQLite client for Node.js applications with SQL-based migrations API written in Typescript</a></header><div>SQLite client for Node.js applications with SQL-based migrations API written in Typescript - kriasoft/node-sqlite</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242383337353695233"
            target="_blank">2020/3/24 18:30:44</a></p>
      </header>
      <section>
        <p class="tweet-text">やっぱりいたよね。。しかしJSのPromiseでくるむのではなく、ネイティブ側でくるむ方法ってないのなあとちょっと考えていた。ちょっと調べてみようかなと思っている。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242383927756517377"
            target="_blank">2020/3/24 18:33:05</a></p>
      </header>
      <section>
        <p class="tweet-text">なぜかNANをいじってみたくなってきたので。どんどん横道にそれて行っているが、これが許されるのは趣味でやっているからにほかならない。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242384153871413248"
            target="_blank">2020/3/24 18:33:59</a></p>
      </header>
      <section>
        <p class="tweet-text">こうして完成から遠のいていくのであった。。こういうのもう２０年以上続けてるからね。。C++をメインでいじっているときからそうだった。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242385447570952193"
            target="_blank">2020/3/24 18:39:07</a></p>
      </header>
      <section>
        <p class="tweet-text">C++とJSはまったく違う言語だけど、プログラミング・パラダイムという点において自由な感じ（悪く言うと節操がない）が似ている気がするし、そこが好きなところでもある。ちゅうてもC++の知識は11の手前くらいまでで止まっているので、今見るとまた違った感じを持つかもしれんけどね。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242389202282536961"
            target="_blank">2020/3/24 18:54:02</a></p>
      </header>
      <section>
        <p class="tweet-text">ネイティブ・モジュールはC++とJSを使って作るので私にとってはとっつきやすい気もするんだよね。それやった時点でブラウザでは使えんようになってしまうんだけど。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242390197330821120"
            target="_blank">2020/3/24 18:58:00</a></p>
      </header>
      <section>
        <p class="tweet-text">Web SQLはバックエンドにsqliteを使ってたと思うんだけど、規格自体が終わったもんなあ。<br/><br/><blockquote class="card card-default"><header><div class="no-image" >No Image</div><a href="https://www.w3.org/TR/webdatabase/" target="_blank">Web SQL Database</a></header><div></div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242390645488013312"
            target="_blank">2020/3/24 18:59:47</a></p>
      </header>
      <section>
        <p class="tweet-text">これは惜しかったよねえ。。AppleとGoogleは支持したけど、MSとMozillaが不支持だったそうな。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242390766984425472"
            target="_blank">2020/3/24 19:00:16</a></p>
      </header>
      <section>
        <p class="tweet-text">セキュリティ的な懸念があるのか、そこまでの機能はブラウザには不要と考えたのか。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242399868380839937"
            target="_blank">2020/3/24 19:36:25</a></p>
      </header>
      <section>
        <p class="tweet-text">Indexed DBに取って代わられた感じなんだよな。キー・バリューストアでオブジェクトをそのまま保存できるのか。。なかなか面白い仕様ですな。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242400649662218242"
            target="_blank">2020/3/24 19:39:32</a></p>
      </header>
      <section>
        <p class="tweet-text">ああ、そういえば一時期dexieというIndexedDBをラップしたやつも使ってみたりしてたな。<br/><br/><blockquote class="card card-default"><header><div class="no-image" >No Image</div><a href="https://dexie.org/" target="_blank">Dexie.js - Minimalistic IndexedDB Wrapper</a></header><div></div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242400819955171329"
            target="_blank">2020/3/24 19:40:12</a></p>
      </header>
      <section>
        <p class="tweet-text">なんのためにこれを試したんだっけかな？？</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242417366748684288"
            target="_blank">2020/3/24 20:45:57</a></p>
      </header>
      <section>
        <p class="tweet-text">sqlite自体をemscriptenでコンパイルしたっちゅうのもあるんだなあ。。<br/><br/><blockquote class="card card-large"><header><img  src="https://repository-images.githubusercontent.com/3556910/77d0d480-638b-11ea-849a-046869c84cfe" /><a href="https://github.com/sql-js/sql.js" target="_blank">GitHub - sql-js/sql.js: A javascript library to run SQLite on the web.</a></header><div>A javascript library to run SQLite on the web.  . Contribute to sql-js/sql.js development by creating an account on GitHub.</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242554584540672000"
            target="_blank">2020/3/25 5:51:13</a></p>
      </header>
      <section>
        <p class="tweet-text">なんとなくネイティブ側でpromiseを返すことはできそうなので、ちょっとコードをまじめに読むことにした。<br/>データは暗号化したいのでnode-sqlcipherをforkしてコードを読み始めた。がまずNANを知らんので「なにこれ？」と思うことが多発。。<br/><br/><blockquote class="card card-default"><header><img  src="https://avatars0.githubusercontent.com/u/3806814?s=400&v=4" /><a href="https://github.com/sfpgmr/node-sqlcipher" target="_blank">GitHub - sfpgmr/node-sqlcipher: SQLCipher bindings for Node</a></header><div>SQLCipher bindings for Node. Contribute to sfpgmr/node-sqlcipher development by creating an account on GitHub.</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242555206757302272"
            target="_blank">2020/3/25 5:53:41</a></p>
      </header>
      <section>
        <p class="tweet-text">そもそもsqlcipherのCソースを読まんといかんのでは？とも思うがとりあえずラッパーのソースを読めばNANと元ソースの雰囲気が掴めるのではという甘い期待（笑）</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242555457522110464"
            target="_blank">2020/3/25 5:54:41</a></p>
      </header>
      <section>
        <p class="tweet-text">まずdatabase.hを読んでNAN_METHODにぶち当たる。<br/><br/><blockquote class="card card-default"><header><img  src="https://avatars0.githubusercontent.com/u/3806814?s=400&v=4" /><a href="https://github.com/sfpgmr/node-sqlcipher/blob/master/src/database.h" target="_blank">node-sqlcipher/database.h at master · sfpgmr/node-sqlcipher · GitHub</a></header><div>SQLCipher bindings for Node. Contribute to sfpgmr/node-sqlcipher development by creating an account on GitHub.</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242555904857235456"
            target="_blank">2020/3/25 5:56:27</a></p>
      </header>
      <section>
        <p class="tweet-text">NAN_METHODはソース読めばわかるだろうということで<blockquote class="card card-default"><header><div class="no-image" >No Image</div><a href="http://database.cc" target="_blank">Domain for sale</a></header><div></div></blockquote>を読んでみる。件のSerialize部分を読もうとした。メソッドはこの辺にある。<br/><br/><blockquote class="card card-default"><header><img  src="https://avatars0.githubusercontent.com/u/3806814?s=400&v=4" /><a href="https://github.com/sfpgmr/node-sqlcipher/blob/master/src/database.cc#L289" target="_blank">node-sqlcipher/database.cc at master · sfpgmr/node-sqlcipher · GitHub</a></header><div>SQLCipher bindings for Node. Contribute to sfpgmr/node-sqlcipher development by creating an account on GitHub.</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242556492705759232"
            target="_blank">2020/3/25 5:58:48</a></p>
      </header>
      <section>
        <p class="tweet-text">メソッドの冒頭。いきなりinfoという変数が出現。なぜこれ定義なしでいきなり出てくるの？とおもってこれひょっとしてメンバ変数かなあ？と思ってヘッダを見直してもない。調べた結果NAN_METHODマクロに隠されていたのであった。。 https://t.co/GkQSucTmcw</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/ET5yI0nUEAEghPY.png" />
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242557249332994048"
            target="_blank">2020/3/25 6:01:48</a></p>
      </header>
      <section>
        <p class="tweet-text">こう展開されるのであった。。<br/>NAN_METHOD(methodname)<br/>↓<br/>void methodname(const Nan::FunctionCallbackInfo&lt;v8::Value&gt;&amp; info);</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242557944169824256"
            target="_blank">2020/3/25 6:04:34</a></p>
      </header>
      <section>
        <p class="tweet-text">ちゅうかネイティブ・アドオン（C++ Addon）の勉強をきちんとやれよ！とも思うが、それはおいおいやるとして。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242558468894027776"
            target="_blank">2020/3/25 6:06:39</a></p>
      </header>
      <section>
        <p class="tweet-text">NAN_METHODはstaticでインプリするからthisはinfoの中にあるんだなあとちょっと思った。<br/><br/>Database* db = Nan::ObjectWrap::Unwrap&lt;Database&gt;(info.This());<br/><br/>Databaseクラスのインスタンスをここで取り出しているもんね。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242558776168738816"
            target="_blank">2020/3/25 6:07:52</a></p>
      </header>
      <section>
        <p class="tweet-text">ちらちらv8なんちゅうキーワードも出てきて、v8の端っこをいじってる感じがなんともいいねえ。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242577549399437312"
            target="_blank">2020/3/25 7:22:28</a></p>
      </header>
      <section>
        <p class="tweet-text">Serializeの動きは引数のcallbackを呼んで、db操作メソッドをstd::queueに溜め込み、そしてProcessでqueueからデータを取り出して実行するようだ。しかしまだ確証はない。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242578316885811201"
            target="_blank">2020/3/25 7:25:31</a></p>
      </header>
      <section>
        <p class="tweet-text">よくわからんのが以下の部分。<br/>TRY_CATCH_CALL(info.This(), callback, 0, NULL);<br/><blockquote class="card card-default"><header><img  src="https://avatars0.githubusercontent.com/u/3806814?s=400&v=4" /><a href="https://github.com/sfpgmr/node-sqlcipher/blob/bca45de1b893323abb4cd49bdcf4f445574312d8/src/database.cc#L297" target="_blank">node-sqlcipher/database.cc at bca45de1b893323abb4cd49bdcf4f445574312d8 · sfpgmr/node-sqlcipher · GitHub</a></header><div>SQLCipher bindings for Node. Contribute to sfpgmr/node-sqlcipher development by creating an account on GitHub.</div></blockquote><br/><br/>TRY_CATCH_CALLマクロは  Nan::MakeCallback((context), (callback), (argc), (argv))に展開される。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242579149887172608"
            target="_blank">2020/3/25 7:28:49</a></p>
      </header>
      <section>
        <p class="tweet-text">なんでこれがTRY_CATCH_CALLなんだろう？と思ってるところ。そしてこのマクロで展開される    Nan::MakeCallbackというのが、果たしてコールバックを作って実行までやってくれるのかなあ？と思って今調べてた。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242579739593699328"
            target="_blank">2020/3/25 7:31:10</a></p>
      </header>
      <section>
        <p class="tweet-text">がしかし、、。Nan::MakeCallbackはdeprecatedらしい。<br/><br/><blockquote class="card card-default"><header><img  src="https://avatars1.githubusercontent.com/u/9950313?s=400&v=4" /><a href="https://github.com/nodejs/nan/blob/master/doc/node_misc.md#nanmakecallback" target="_blank">nan/node_misc.md at master · nodejs/nan · GitHub</a></header><div>Native Abstractions for Node.js. Contribute to nodejs/nan development by creating an account on GitHub.</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242581686426066944"
            target="_blank">2020/3/25 7:38:54</a></p>
      </header>
      <section>
        <p class="tweet-text">いまはAsyncResourceとAsyncResource::runInAsyncScopeを使えとある。このメソッド名を見る限りこのメソッドは引数として渡すメソッド実行してくれそうだ。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242582333963653120"
            target="_blank">2020/3/25 7:41:29</a></p>
      </header>
      <section>
        <p class="tweet-text">もしくはv8::Function#Call()を直接呼べとある。まあやはりここでコールバックを呼んでるのは間違いないですわな。。そうせんとコードのつじつまが合わん。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242582714521288709"
            target="_blank">2020/3/25 7:42:59</a></p>
      </header>
      <section>
        <p class="tweet-text">MakeCallbackという名前からは関数の実行はイメージできないわな。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242583292206911488"
            target="_blank">2020/3/25 7:45:17</a></p>
      </header>
      <section>
        <p class="tweet-text">そしてSerializeメソッドの301行目で<br/><br/>    db-&gt;Process();<br/><br/>を呼んでる。このメソッドの中を見てみることにする。<br/><br/><blockquote class="card card-default"><header><img  src="https://avatars0.githubusercontent.com/u/3806814?s=400&v=4" /><a href="https://github.com/sfpgmr/node-sqlcipher/blob/bca45de1b893323abb4cd49bdcf4f445574312d8/src/database.cc#L301" target="_blank">node-sqlcipher/database.cc at bca45de1b893323abb4cd49bdcf4f445574312d8 · sfpgmr/node-sqlcipher · GitHub</a></header><div>SQLCipher bindings for Node. Contribute to sfpgmr/node-sqlcipher development by creating an account on GitHub.</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242585300586524677"
            target="_blank">2020/3/25 7:53:16</a></p>
      </header>
      <section>
        <p class="tweet-text">Database::Process()は31行目にあった。39-66行目までの処理はdbが開いてないのでqueueに溜まってる処理オブジェクトに対してエラーコールバックの指定があればそれを呼んでいる。<br/><br/><blockquote class="card card-default"><header><img  src="https://avatars0.githubusercontent.com/u/3806814?s=400&v=4" /><a href="https://github.com/sfpgmr/node-sqlcipher/blob/bca45de1b893323abb4cd49bdcf4f445574312d8/src/database.cc#L36" target="_blank">node-sqlcipher/database.cc at bca45de1b893323abb4cd49bdcf4f445574312d8 · sfpgmr/node-sqlcipher · GitHub</a></header><div>SQLCipher bindings for Node. Contribute to sfpgmr/node-sqlcipher development by creating an account on GitHub.</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242586854228017152"
            target="_blank">2020/3/25 7:59:26</a></p>
      </header>
      <section>
        <p class="tweet-text">68-81行でqueueからCallオブジェクトを取り出し、callback()を呼んでいる。このCallオブジェクトはなんぞやと思うわけですが。それはdatabase.hに定義してあった。<br/><blockquote class="card card-default"><header><img  src="https://avatars0.githubusercontent.com/u/3806814?s=400&v=4" /><a href="https://github.com/sfpgmr/node-sqlcipher/blob/bca45de1b893323abb4cd49bdcf4f445574312d8/src/database.h#L73" target="_blank">node-sqlcipher/database.h at bca45de1b893323abb4cd49bdcf4f445574312d8 · sfpgmr/node-sqlcipher · GitHub</a></header><div>SQLCipher bindings for Node. Contribute to sfpgmr/node-sqlcipher development by creating an account on GitHub.</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242916895981895680"
            target="_blank">2020/3/26 5:50:54</a></p>
      </header>
      <section>
        <p class="tweet-text">Callは<br/><br/>Work_Callback callback;<br/>bool exclusive;<br/>Baton* baton;<br/><br/>の３つのメンバを持つクラスですな。 https://t.co/DiDYc9BJJA</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/ET-6Cm4UwAAhGKV.png" />
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242917944591396864"
            target="_blank">2020/3/26 5:55:04</a></p>
      </header>
      <section>
        <p class="tweet-text">Work_CallBackは*Batonを引数に持つ関数ポインタのtypedefですな。<br/><br/>typedef void (*Work_Callback)(Baton* baton);</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242918399388217344"
            target="_blank">2020/3/26 5:56:53</a></p>
      </header>
      <section>
        <p class="tweet-text">Work_Callbackには処理する関数へのポインタ、そしてその関数に渡すパラメータをBatonに入れてこのCallオブジェクトに格納し、さらにstd::queue&lt;Call *&gt;に格納するわけですな。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242920143107158017"
            target="_blank">2020/3/26 6:03:49</a></p>
      </header>
      <section>
        <p class="tweet-text">つまり Database::Process()の68-82行で行っているのはqueueから*Callを取り出し、callbackメンバに入っている関数をbatonメンバを引数に呼び出している。これをqueueが空になるか、lockedメンバがtrueでない限りループする。<br/><br/><blockquote class="card card-default"><header><img  src="https://avatars0.githubusercontent.com/u/3806814?s=400&v=4" /><a href="https://github.com/sfpgmr/node-sqlcipher/blob/bca45de1b893323abb4cd49bdcf4f445574312d8/src/database.cc#L68-L82" target="_blank">node-sqlcipher/database.cc at bca45de1b893323abb4cd49bdcf4f445574312d8 · sfpgmr/node-sqlcipher · GitHub</a></header><div>SQLCipher bindings for Node. Contribute to sfpgmr/node-sqlcipher development by creating an account on GitHub.</div></blockquote></p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242920644955607040"
            target="_blank">2020/3/26 6:05:48</a></p>
      </header>
      <section>
        <p class="tweet-text">lockedメンバはDataBaseが持つメンバですな。C++はメンバへのアクセスはthisポインタ不要なんだよな。。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242920915748270080"
            target="_blank">2020/3/26 6:06:53</a></p>
      </header>
      <section>
        <p class="tweet-text">ああ、正確には「自身のメンバへのアクセスはthisポインタ不要」か。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242934014664519680"
            target="_blank">2020/3/26 6:58:56</a></p>
      </header>
      <section>
        <p class="tweet-text">ループ中ではlockedメンバにCall::exclusiveの値が代入される。このメンバはserializeやexclusiveといったメンバの値が入るようだ。Database::serializeが呼ばれたときはserialize=trueになるので、Process中ではqueueに溜まったCallは１つしか処理されないことになるよな。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242934930880884736"
            target="_blank">2020/3/26 7:02:34</a></p>
      </header>
      <section>
        <p class="tweet-text">またDatabase::Parallelize()はserializeにfalseがセットされる以外はDatabase::serialize()と処理は同じ。Database::Process()でParallelize()中のDBに対する処理は同時に実行されることになる。</p>
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242935795339497472"
            target="_blank">2020/3/26 7:06:00</a></p>
      </header>
      <section>
        <p class="tweet-text">でこのqueueに*Callを放り込むのはどの関数かというとDatabase::Scheduleなわけですな。<br/><br/><blockquote class="card card-default"><header><img  src="https://avatars0.githubusercontent.com/u/3806814?s=400&v=4" /><a href="https://github.com/sfpgmr/node-sqlcipher/blob/bca45de1b893323abb4cd49bdcf4f445574312d8/src/database.cc#L84%E3%83%BCL108" target="_blank">node-sqlcipher/database.cc at bca45de1b893323abb4cd49bdcf4f445574312d8 · sfpgmr/node-sqlcipher · GitHub</a></header><div>SQLCipher bindings for Node. Contribute to sfpgmr/node-sqlcipher development by creating an account on GitHub.</div></blockquote> https://t.co/zDZYQnePqY</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/ET_LhDQUcAAUTAh.jpg" />
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242938034208649216"
            target="_blank">2020/3/26 7:14:54</a></p>
      </header>
      <section>
        <p class="tweet-text">Database::Scheduleの87-99行目はopenがfalseそしてlocked=trueの場合データベースがクローズされているとして例外を発行するようである。EXCEPTIONマクロがまたこれが？？なやつでして。。<br/><br/><blockquote class="card card-default"><header><img  src="https://avatars0.githubusercontent.com/u/3806814?s=400&v=4" /><a href="https://github.com/sfpgmr/node-sqlcipher/blob/master/src/database.cc#L87-L99" target="_blank">node-sqlcipher/database.cc at master · sfpgmr/node-sqlcipher · GitHub</a></header><div>SQLCipher bindings for Node. Contribute to sfpgmr/node-sqlcipher development by creating an account on GitHub.</div></blockquote> https://t.co/95WbYMxrP4</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/ET_NMJgU0AEK-_y.jpg" />
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242938745592012801"
            target="_blank">2020/3/26 7:17:44</a></p>
      </header>
      <section>
        <p class="tweet-text">マクロ定義を読むと、V8というかnodeの例外オブジェクトを作るマクロであることがわかる。 https://t.co/qOxTBXojSw</p>
        
        <img  class="tweet-img" src="https://pbs.twimg.com/media/ET_N1uMUMAEcRXV.png" />
        
      </section>
      
      <header class="tweet-header">
        
        <p class="tweet-date"><a href="https://twitter.com/SFPGMR/status/1242939890582470656"
            target="_blank">2020/3/26 7:22:17</a></p>
      </header>
      <section>
        <p class="tweet-text">今回のケースだと<br/> EXCEPTION("Database is closed", SQLITE_MISUSE, exception);<br/>なので、Local&lt;Value&gt;型のexception変数とLocal&lt;Object&gt;型のexception_obj変数が作られる。Local&lt;ほにゃらら&gt;はv8(node)上のローカルスコープかなあ？と思いつつ進める。</p>
        
      </section>
      
    </article>
    
  </div>
  <footer>
    CopyLight 2019 Satoshi Fujiwara
  </footer>
  <script async src="https://platform.twitter.com/widgets.js"></script>

  <script async src="./index.js"></script>

</body>

</html>